package META-INF.versions.9.org.bouncycastle.asn1;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import org.bouncycastle.asn1.ASN1Encodable;
import org.bouncycastle.asn1.ASN1EncodableVector;
import org.bouncycastle.asn1.ASN1Exception;
import org.bouncycastle.asn1.ASN1InputStream;
import org.bouncycastle.asn1.ASN1Primitive;
import org.bouncycastle.asn1.ASN1StreamParser;
import org.bouncycastle.asn1.BERApplicationSpecificParser;
import org.bouncycastle.asn1.BERFactory;
import org.bouncycastle.asn1.BEROctetStringParser;
import org.bouncycastle.asn1.BERPrivateParser;
import org.bouncycastle.asn1.BERSequenceParser;
import org.bouncycastle.asn1.BERSetParser;
import org.bouncycastle.asn1.BERTaggedObject;
import org.bouncycastle.asn1.BERTaggedObjectParser;
import org.bouncycastle.asn1.DERExternalParser;
import org.bouncycastle.asn1.DEROctetString;
import org.bouncycastle.asn1.DEROctetStringParser;
import org.bouncycastle.asn1.DLApplicationSpecific;
import org.bouncycastle.asn1.DLFactory;
import org.bouncycastle.asn1.DLPrivate;
import org.bouncycastle.asn1.DLSequenceParser;
import org.bouncycastle.asn1.DLSetParser;
import org.bouncycastle.asn1.DLTaggedObject;
import org.bouncycastle.asn1.DefiniteLengthInputStream;
import org.bouncycastle.asn1.InMemoryRepresentable;
import org.bouncycastle.asn1.IndefiniteLengthInputStream;
import org.bouncycastle.asn1.StreamUtil;

public class ASN1StreamParser {
  private final InputStream _in;
  
  private final int _limit;
  
  private final byte[][] tmpBuffers;
  
  public ASN1StreamParser(InputStream paramInputStream) { this(paramInputStream, StreamUtil.findLimit(paramInputStream)); }
  
  public ASN1StreamParser(InputStream paramInputStream, int paramInt) {
    this._in = paramInputStream;
    this._limit = paramInt;
    this.tmpBuffers = new byte[11][];
  }
  
  public ASN1StreamParser(byte[] paramArrayOfByte) { this(new ByteArrayInputStream(paramArrayOfByte), paramArrayOfByte.length); }
  
  ASN1Encodable readIndef(int paramInt) throws IOException {
    switch (paramInt) {
      case 8:
        return new DERExternalParser(this);
      case 4:
        return new BEROctetStringParser(this);
      case 16:
        return new BERSequenceParser(this);
      case 17:
        return new BERSetParser(this);
    } 
    throw new ASN1Exception("unknown BER object encountered: 0x" + Integer.toHexString(paramInt));
  }
  
  ASN1Encodable readImplicit(boolean paramBoolean, int paramInt) throws IOException {
    if (this._in instanceof IndefiniteLengthInputStream) {
      if (!paramBoolean)
        throw new IOException("indefinite-length primitive encoding encountered"); 
      return readIndef(paramInt);
    } 
    if (paramBoolean) {
      switch (paramInt) {
        case 17:
          return new DLSetParser(this);
        case 16:
          return new DLSequenceParser(this);
        case 4:
          return new BEROctetStringParser(this);
      } 
    } else {
      switch (paramInt) {
        case 17:
          throw new ASN1Exception("sequences must use constructed encoding (see X.690 8.9.1/8.10.1)");
        case 16:
          throw new ASN1Exception("sets must use constructed encoding (see X.690 8.11.1/8.12.1)");
        case 4:
          return new DEROctetStringParser((DefiniteLengthInputStream)this._in);
      } 
    } 
    throw new ASN1Exception("implicit tagging not implemented");
  }
  
  ASN1Primitive readTaggedObject(boolean paramBoolean, int paramInt) throws IOException {
    if (!paramBoolean) {
      DefiniteLengthInputStream definiteLengthInputStream = (DefiniteLengthInputStream)this._in;
      return new DLTaggedObject(false, paramInt, new DEROctetString(definiteLengthInputStream.toByteArray()));
    } 
    ASN1EncodableVector aSN1EncodableVector = readVector();
    if (this._in instanceof IndefiniteLengthInputStream)
      return (aSN1EncodableVector.size() == 1) ? 
        new BERTaggedObject(true, paramInt, aSN1EncodableVector.get(0)) : 
        new BERTaggedObject(false, paramInt, BERFactory.createSequence(aSN1EncodableVector)); 
    return (aSN1EncodableVector.size() == 1) ? 
      new DLTaggedObject(true, paramInt, aSN1EncodableVector.get(0)) : 
      new DLTaggedObject(false, paramInt, DLFactory.createSequence(aSN1EncodableVector));
  }
  
  public ASN1Encodable readObject() throws IOException {
    int i = this._in.read();
    if (i == -1)
      return null; 
    set00Check(false);
    int j = ASN1InputStream.readTagNumber(this._in, i);
    boolean bool = ((i & 0x20) != 0);
    int k = ASN1InputStream.readLength(this._in, this._limit, (j == 4 || j == 16 || j == 17 || j == 8));
    if (k < 0) {
      if (!bool)
        throw new IOException("indefinite-length primitive encoding encountered"); 
      IndefiniteLengthInputStream indefiniteLengthInputStream = new IndefiniteLengthInputStream(this._in, this._limit);
      ASN1StreamParser aSN1StreamParser = new ASN1StreamParser(indefiniteLengthInputStream, this._limit);
      if ((i & 0xC0) == 192)
        return new BERPrivateParser(j, aSN1StreamParser); 
      if ((i & 0x40) != 0)
        return new BERApplicationSpecificParser(j, aSN1StreamParser); 
      if ((i & 0x80) != 0)
        return new BERTaggedObjectParser(true, j, aSN1StreamParser); 
      return aSN1StreamParser.readIndef(j);
    } 
    DefiniteLengthInputStream definiteLengthInputStream = new DefiniteLengthInputStream(this._in, k, this._limit);
    if ((i & 0xC0) == 192)
      return new DLPrivate(bool, j, definiteLengthInputStream.toByteArray()); 
    if ((i & 0x40) != 0)
      return new DLApplicationSpecific(bool, j, definiteLengthInputStream.toByteArray()); 
    if ((i & 0x80) != 0)
      return new BERTaggedObjectParser(bool, j, new ASN1StreamParser(definiteLengthInputStream)); 
    if (bool) {
      switch (j) {
        case 4:
          return new BEROctetStringParser(new ASN1StreamParser(definiteLengthInputStream));
        case 16:
          return new DLSequenceParser(new ASN1StreamParser(definiteLengthInputStream));
        case 17:
          return new DLSetParser(new ASN1StreamParser(definiteLengthInputStream));
        case 8:
          return new DERExternalParser(new ASN1StreamParser(definiteLengthInputStream));
      } 
      throw new IOException("unknown tag " + j + " encountered");
    } 
    switch (j) {
      case 4:
        return new DEROctetStringParser(definiteLengthInputStream);
    } 
    try {
      return ASN1InputStream.createPrimitiveDERObject(j, definiteLengthInputStream, this.tmpBuffers);
    } catch (IllegalArgumentException illegalArgumentException) {
      throw new ASN1Exception("corrupted stream detected", illegalArgumentException);
    } 
  }
  
  private void set00Check(boolean paramBoolean) {
    if (this._in instanceof IndefiniteLengthInputStream)
      ((IndefiniteLengthInputStream)this._in).setEofOn00(paramBoolean); 
  }
  
  ASN1EncodableVector readVector() throws IOException {
    ASN1Encodable aSN1Encodable = readObject();
    if (null == aSN1Encodable)
      return new ASN1EncodableVector(0); 
    ASN1EncodableVector aSN1EncodableVector = new ASN1EncodableVector();
    do {
      if (aSN1Encodable instanceof InMemoryRepresentable) {
        aSN1EncodableVector.add(((InMemoryRepresentable)aSN1Encodable).getLoadedObject());
      } else {
        aSN1EncodableVector.add(aSN1Encodable.toASN1Primitive());
      } 
    } while ((aSN1Encodable = readObject()) != null);
    return aSN1EncodableVector;
  }
}
