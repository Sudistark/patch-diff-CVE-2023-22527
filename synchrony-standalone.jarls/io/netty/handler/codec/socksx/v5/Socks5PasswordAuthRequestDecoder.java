package io.netty.handler.codec.socksx.v5;

import io.netty.buffer.ByteBuf;
import io.netty.channel.ChannelHandlerContext;
import io.netty.handler.codec.DecoderException;
import io.netty.handler.codec.DecoderResult;
import io.netty.handler.codec.ReplayingDecoder;
import io.netty.util.CharsetUtil;
import java.util.List;

public class Socks5PasswordAuthRequestDecoder extends ReplayingDecoder<Socks5PasswordAuthRequestDecoder.State> {
  public Socks5PasswordAuthRequestDecoder() { super(State.INIT); }
  
  protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {
    try {
      int totalLength;
      int passwordLength;
      int usernameLength;
      byte version;
      int readableBytes;
      int startOffset;
      switch (null.$SwitchMap$io$netty$handler$codec$socksx$v5$Socks5PasswordAuthRequestDecoder$State[((State)state()).ordinal()]) {
        case 1:
          startOffset = in.readerIndex();
          version = in.getByte(startOffset);
          if (version != 1)
            throw new DecoderException("unsupported subnegotiation version: " + version + " (expected: 1)"); 
          usernameLength = in.getUnsignedByte(startOffset + 1);
          passwordLength = in.getUnsignedByte(startOffset + 2 + usernameLength);
          totalLength = usernameLength + passwordLength + 3;
          in.skipBytes(totalLength);
          out.add(new DefaultSocks5PasswordAuthRequest(in
                .toString(startOffset + 2, usernameLength, CharsetUtil.US_ASCII), in
                .toString(startOffset + 3 + usernameLength, passwordLength, CharsetUtil.US_ASCII)));
          checkpoint(State.SUCCESS);
        case 2:
          readableBytes = actualReadableBytes();
          if (readableBytes > 0)
            out.add(in.readRetainedSlice(readableBytes)); 
          break;
        case 3:
          in.skipBytes(actualReadableBytes());
          break;
      } 
    } catch (Exception e) {
      fail(out, e);
    } 
  }
  
  private void fail(List<Object> out, Exception cause) {
    DecoderException decoderException;
    if (!(cause instanceof DecoderException))
      decoderException = new DecoderException(cause); 
    checkpoint(State.FAILURE);
    DefaultSocks5PasswordAuthRequest defaultSocks5PasswordAuthRequest = new DefaultSocks5PasswordAuthRequest("", "");
    defaultSocks5PasswordAuthRequest.setDecoderResult(DecoderResult.failure(decoderException));
    out.add(defaultSocks5PasswordAuthRequest);
  }
}
