package io.netty.handler.ssl;

import io.netty.util.internal.ObjectUtil;
import java.util.LinkedHashSet;
import javax.net.ssl.SSLEngine;
import org.eclipse.jetty.npn.NextProtoNego;

final class JettyNpnSslEngine extends JdkSslEngine {
  private static boolean available;
  
  static boolean isAvailable() {
    updateAvailability();
    return available;
  }
  
  private static void updateAvailability() {
    if (available)
      return; 
    try {
      Class.forName("sun.security.ssl.NextProtoNegoExtension", true, null);
      available = true;
    } catch (Exception exception) {}
  }
  
  JettyNpnSslEngine(SSLEngine engine, JdkApplicationProtocolNegotiator applicationNegotiator, boolean server) {
    super(engine);
    ObjectUtil.checkNotNull(applicationNegotiator, "applicationNegotiator");
    if (server) {
      JdkApplicationProtocolNegotiator.ProtocolSelectionListener protocolListener = (JdkApplicationProtocolNegotiator.ProtocolSelectionListener)ObjectUtil.checkNotNull(applicationNegotiator
          .protocolListenerFactory().newListener(this, applicationNegotiator.protocols()), "protocolListener");
      NextProtoNego.put(engine, new Object(this, protocolListener, applicationNegotiator));
    } else {
      JdkApplicationProtocolNegotiator.ProtocolSelector protocolSelector = (JdkApplicationProtocolNegotiator.ProtocolSelector)ObjectUtil.checkNotNull(applicationNegotiator.protocolSelectorFactory()
          .newSelector(this, new LinkedHashSet(applicationNegotiator.protocols())), "protocolSelector");
      NextProtoNego.put(engine, new Object(this, protocolSelector));
    } 
  }
  
  public void closeInbound() {
    NextProtoNego.remove(getWrappedEngine());
    super.closeInbound();
  }
  
  public void closeOutbound() {
    NextProtoNego.remove(getWrappedEngine());
    super.closeOutbound();
  }
}
