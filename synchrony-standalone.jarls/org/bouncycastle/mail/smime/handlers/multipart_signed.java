package org.bouncycastle.mail.smime.handlers;

import java.awt.datatransfer.DataFlavor;
import java.io.BufferedInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.Enumeration;
import javax.activation.ActivationDataFlavor;
import javax.activation.DataContentHandler;
import javax.activation.DataSource;
import javax.mail.MessagingException;
import javax.mail.Multipart;
import javax.mail.internet.ContentType;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMultipart;
import org.bouncycastle.mail.smime.SMIMEStreamingProcessor;
import org.bouncycastle.mail.smime.SMIMEUtil;

public class multipart_signed implements DataContentHandler {
  private static final ActivationDataFlavor ADF = new ActivationDataFlavor(MimeMultipart.class, "multipart/signed", "Multipart Signed");
  
  private static final DataFlavor[] DFS = { ADF };
  
  public Object getContent(DataSource paramDataSource) throws IOException {
    try {
      return new MimeMultipart(paramDataSource);
    } catch (MessagingException messagingException) {
      return null;
    } 
  }
  
  public Object getTransferData(DataFlavor paramDataFlavor, DataSource paramDataSource) throws IOException { return ADF.equals(paramDataFlavor) ? getContent(paramDataSource) : null; }
  
  public DataFlavor[] getTransferDataFlavors() { return DFS; }
  
  public void writeTo(Object paramObject, String paramString, OutputStream paramOutputStream) throws IOException {
    if (paramObject instanceof MimeMultipart) {
      try {
        outputBodyPart(paramOutputStream, paramObject);
      } catch (MessagingException messagingException) {
        throw new IOException(messagingException.getMessage());
      } 
    } else if (paramObject instanceof byte[]) {
      paramOutputStream.write((byte[])paramObject);
    } else if (paramObject instanceof InputStream) {
      InputStream inputStream = (InputStream)paramObject;
      if (!(inputStream instanceof BufferedInputStream))
        inputStream = new BufferedInputStream(inputStream); 
      int i;
      while ((i = inputStream.read()) >= 0)
        paramOutputStream.write(i); 
      inputStream.close();
    } else if (paramObject instanceof SMIMEStreamingProcessor) {
      SMIMEStreamingProcessor sMIMEStreamingProcessor = (SMIMEStreamingProcessor)paramObject;
      sMIMEStreamingProcessor.write(paramOutputStream);
    } else {
      throw new IOException("unknown object in writeTo " + paramObject);
    } 
  }
  
  private void outputBodyPart(OutputStream paramOutputStream, Object paramObject) throws MessagingException, IOException {
    if (paramObject instanceof Multipart) {
      Multipart multipart = (Multipart)paramObject;
      ContentType contentType = new ContentType(multipart.getContentType());
      String str = "--" + contentType.getParameter("boundary");
      LineOutputStream lineOutputStream = new LineOutputStream(paramOutputStream);
      for (byte b = 0; b < multipart.getCount(); b++) {
        lineOutputStream.writeln(str);
        outputBodyPart(paramOutputStream, multipart.getBodyPart(b));
        lineOutputStream.writeln();
      } 
      lineOutputStream.writeln(str + "--");
      return;
    } 
    MimeBodyPart mimeBodyPart = (MimeBodyPart)paramObject;
    if (SMIMEUtil.isMultipartContent(mimeBodyPart)) {
      Object object = mimeBodyPart.getContent();
      if (object instanceof Multipart) {
        Multipart multipart = (Multipart)object;
        ContentType contentType = new ContentType(multipart.getContentType());
        String str = "--" + contentType.getParameter("boundary");
        LineOutputStream lineOutputStream = new LineOutputStream(paramOutputStream);
        Enumeration enumeration = mimeBodyPart.getAllHeaderLines();
        while (enumeration.hasMoreElements())
          lineOutputStream.writeln((String)enumeration.nextElement()); 
        lineOutputStream.writeln();
        outputPreamble(lineOutputStream, mimeBodyPart, str);
        outputBodyPart(paramOutputStream, multipart);
        return;
      } 
    } 
    mimeBodyPart.writeTo(paramOutputStream);
  }
  
  static void outputPreamble(LineOutputStream paramLineOutputStream, MimeBodyPart paramMimeBodyPart, String paramString) throws MessagingException, IOException {
    InputStream inputStream;
    try {
      inputStream = paramMimeBodyPart.getRawInputStream();
    } catch (MessagingException messagingException) {
      return;
    } 
    String str;
    while ((str = readLine(inputStream)) != null && !str.equals(paramString))
      paramLineOutputStream.writeln(str); 
    inputStream.close();
    if (str == null)
      throw new MessagingException("no boundary found"); 
  }
  
  private static String readLine(InputStream paramInputStream) throws IOException {
    StringBuffer stringBuffer = new StringBuffer();
    int i;
    while ((i = paramInputStream.read()) >= 0 && i != 10) {
      if (i != 13)
        stringBuffer.append((char)i); 
    } 
    return (i < 0) ? null : stringBuffer.toString();
  }
}
