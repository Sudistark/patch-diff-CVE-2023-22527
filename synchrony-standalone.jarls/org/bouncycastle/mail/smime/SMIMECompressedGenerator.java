package org.bouncycastle.mail.smime;

import java.security.AccessController;
import javax.activation.CommandMap;
import javax.activation.MailcapCommandMap;
import javax.mail.MessagingException;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMessage;
import org.bouncycastle.operator.OutputCompressor;

public class SMIMECompressedGenerator extends SMIMEGenerator {
  public static final String ZLIB = "1.2.840.113549.1.9.16.3.8";
  
  private static final String COMPRESSED_CONTENT_TYPE = "application/pkcs7-mime; name=\"smime.p7z\"; smime-type=compressed-data";
  
  private MimeBodyPart make(MimeBodyPart paramMimeBodyPart, OutputCompressor paramOutputCompressor) throws SMIMEException {
    try {
      MimeBodyPart mimeBodyPart = new MimeBodyPart();
      mimeBodyPart.setContent(new ContentCompressor(this, paramMimeBodyPart, paramOutputCompressor), "application/pkcs7-mime; name=\"smime.p7z\"; smime-type=compressed-data");
      mimeBodyPart.addHeader("Content-Type", "application/pkcs7-mime; name=\"smime.p7z\"; smime-type=compressed-data");
      mimeBodyPart.addHeader("Content-Disposition", "attachment; filename=\"smime.p7z\"");
      mimeBodyPart.addHeader("Content-Description", "S/MIME Compressed Message");
      mimeBodyPart.addHeader("Content-Transfer-Encoding", this.encoding);
      return mimeBodyPart;
    } catch (MessagingException messagingException) {
      throw new SMIMEException("exception putting multi-part together.", messagingException);
    } 
  }
  
  public MimeBodyPart generate(MimeBodyPart paramMimeBodyPart, OutputCompressor paramOutputCompressor) throws SMIMEException { return make(makeContentBodyPart(paramMimeBodyPart), paramOutputCompressor); }
  
  public MimeBodyPart generate(MimeMessage paramMimeMessage, OutputCompressor paramOutputCompressor) throws SMIMEException {
    try {
      paramMimeMessage.saveChanges();
    } catch (MessagingException messagingException) {
      throw new SMIMEException("unable to save message", messagingException);
    } 
    return make(makeContentBodyPart(paramMimeMessage), paramOutputCompressor);
  }
  
  static  {
    CommandMap commandMap = CommandMap.getDefaultCommandMap();
    if (commandMap instanceof MailcapCommandMap) {
      MailcapCommandMap mailcapCommandMap = (MailcapCommandMap)commandMap;
      mailcapCommandMap.addMailcap("application/pkcs7-mime;; x-java-content-handler=org.bouncycastle.mail.smime.handlers.pkcs7_mime");
      mailcapCommandMap.addMailcap("application/x-pkcs7-mime;; x-java-content-handler=org.bouncycastle.mail.smime.handlers.x_pkcs7_mime");
      AccessController.doPrivileged(new Object(mailcapCommandMap));
    } 
  }
}
