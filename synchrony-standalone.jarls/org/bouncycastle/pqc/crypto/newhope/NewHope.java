package org.bouncycastle.pqc.crypto.newhope;

import java.security.SecureRandom;
import org.bouncycastle.crypto.digests.SHA3Digest;

class NewHope {
  private static final boolean STATISTICAL_TEST = false;
  
  public static final int AGREEMENT_SIZE = 32;
  
  public static final int POLY_SIZE = 1024;
  
  public static final int SENDA_BYTES = 1824;
  
  public static final int SENDB_BYTES = 2048;
  
  public static void keygen(SecureRandom paramSecureRandom, byte[] paramArrayOfByte, short[] paramArrayOfShort) {
    byte[] arrayOfByte1 = new byte[32];
    paramSecureRandom.nextBytes(arrayOfByte1);
    sha3(arrayOfByte1);
    short[] arrayOfShort1 = new short[1024];
    generateA(arrayOfShort1, arrayOfByte1);
    byte[] arrayOfByte2 = new byte[32];
    paramSecureRandom.nextBytes(arrayOfByte2);
    Poly.getNoise(paramArrayOfShort, arrayOfByte2, (byte)0);
    Poly.toNTT(paramArrayOfShort);
    short[] arrayOfShort2 = new short[1024];
    Poly.getNoise(arrayOfShort2, arrayOfByte2, (byte)1);
    Poly.toNTT(arrayOfShort2);
    short[] arrayOfShort3 = new short[1024];
    Poly.pointWise(arrayOfShort1, paramArrayOfShort, arrayOfShort3);
    short[] arrayOfShort4 = new short[1024];
    Poly.add(arrayOfShort3, arrayOfShort2, arrayOfShort4);
    encodeA(paramArrayOfByte, arrayOfShort4, arrayOfByte1);
  }
  
  public static void sharedB(SecureRandom paramSecureRandom, byte[] paramArrayOfByte1, byte[] paramArrayOfByte2, byte[] paramArrayOfByte3) {
    short[] arrayOfShort1 = new short[1024];
    byte[] arrayOfByte1 = new byte[32];
    decodeA(arrayOfShort1, arrayOfByte1, paramArrayOfByte3);
    short[] arrayOfShort2 = new short[1024];
    generateA(arrayOfShort2, arrayOfByte1);
    byte[] arrayOfByte2 = new byte[32];
    paramSecureRandom.nextBytes(arrayOfByte2);
    short[] arrayOfShort3 = new short[1024];
    Poly.getNoise(arrayOfShort3, arrayOfByte2, (byte)0);
    Poly.toNTT(arrayOfShort3);
    short[] arrayOfShort4 = new short[1024];
    Poly.getNoise(arrayOfShort4, arrayOfByte2, (byte)1);
    Poly.toNTT(arrayOfShort4);
    short[] arrayOfShort5 = new short[1024];
    Poly.pointWise(arrayOfShort2, arrayOfShort3, arrayOfShort5);
    Poly.add(arrayOfShort5, arrayOfShort4, arrayOfShort5);
    short[] arrayOfShort6 = new short[1024];
    Poly.pointWise(arrayOfShort1, arrayOfShort3, arrayOfShort6);
    Poly.fromNTT(arrayOfShort6);
    short[] arrayOfShort7 = new short[1024];
    Poly.getNoise(arrayOfShort7, arrayOfByte2, (byte)2);
    Poly.add(arrayOfShort6, arrayOfShort7, arrayOfShort6);
    short[] arrayOfShort8 = new short[1024];
    ErrorCorrection.helpRec(arrayOfShort8, arrayOfShort6, arrayOfByte2, (byte)3);
    encodeB(paramArrayOfByte2, arrayOfShort5, arrayOfShort8);
    ErrorCorrection.rec(paramArrayOfByte1, arrayOfShort6, arrayOfShort8);
    sha3(paramArrayOfByte1);
  }
  
  public static void sharedA(byte[] paramArrayOfByte1, short[] paramArrayOfShort, byte[] paramArrayOfByte2) {
    short[] arrayOfShort1 = new short[1024];
    short[] arrayOfShort2 = new short[1024];
    decodeB(arrayOfShort1, arrayOfShort2, paramArrayOfByte2);
    short[] arrayOfShort3 = new short[1024];
    Poly.pointWise(paramArrayOfShort, arrayOfShort1, arrayOfShort3);
    Poly.fromNTT(arrayOfShort3);
    ErrorCorrection.rec(paramArrayOfByte1, arrayOfShort3, arrayOfShort2);
    sha3(paramArrayOfByte1);
  }
  
  static void decodeA(short[] paramArrayOfShort, byte[] paramArrayOfByte1, byte[] paramArrayOfByte2) {
    Poly.fromBytes(paramArrayOfShort, paramArrayOfByte2);
    System.arraycopy(paramArrayOfByte2, 1792, paramArrayOfByte1, 0, 32);
  }
  
  static void decodeB(short[] paramArrayOfShort1, short[] paramArrayOfShort2, byte[] paramArrayOfByte) {
    Poly.fromBytes(paramArrayOfShort1, paramArrayOfByte);
    for (byte b = 0; b < 'Ā'; b++) {
      byte b1 = 4 * b;
      byte b2 = paramArrayOfByte['܀' + b] & 0xFF;
      paramArrayOfShort2[b1 + 0] = (short)(b2 & 0x3);
      paramArrayOfShort2[b1 + 1] = (short)(b2 >>> 2 & 0x3);
      paramArrayOfShort2[b1 + 2] = (short)(b2 >>> 4 & 0x3);
      paramArrayOfShort2[b1 + 3] = (short)(b2 >>> 6);
    } 
  }
  
  static void encodeA(byte[] paramArrayOfByte1, short[] paramArrayOfShort, byte[] paramArrayOfByte2) {
    Poly.toBytes(paramArrayOfByte1, paramArrayOfShort);
    System.arraycopy(paramArrayOfByte2, 0, paramArrayOfByte1, 1792, 32);
  }
  
  static void encodeB(byte[] paramArrayOfByte, short[] paramArrayOfShort1, short[] paramArrayOfShort2) {
    Poly.toBytes(paramArrayOfByte, paramArrayOfShort1);
    for (byte b = 0; b < 'Ā'; b++) {
      byte b1 = 4 * b;
      paramArrayOfByte['܀' + b] = (byte)(paramArrayOfShort2[b1] | paramArrayOfShort2[b1 + 1] << 2 | paramArrayOfShort2[b1 + 2] << 4 | paramArrayOfShort2[b1 + 3] << 6);
    } 
  }
  
  static void generateA(short[] paramArrayOfShort, byte[] paramArrayOfByte) { Poly.uniform(paramArrayOfShort, paramArrayOfByte); }
  
  static void sha3(byte[] paramArrayOfByte) {
    SHA3Digest sHA3Digest = new SHA3Digest(256);
    sHA3Digest.update(paramArrayOfByte, 0, 32);
    sHA3Digest.doFinal(paramArrayOfByte, 0);
  }
}
