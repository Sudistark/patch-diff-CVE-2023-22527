package org.bouncycastle.jce.provider;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.lang.ref.WeakReference;
import java.net.HttpURLConnection;
import java.net.URI;
import java.security.cert.CRLException;
import java.security.cert.CertificateFactory;
import java.security.cert.X509CRL;
import java.util.Collection;
import java.util.Collections;
import java.util.Date;
import java.util.Hashtable;
import java.util.Map;
import java.util.WeakHashMap;
import javax.naming.NamingException;
import javax.naming.directory.Attribute;
import javax.naming.directory.Attributes;
import javax.naming.directory.InitialDirContext;
import org.bouncycastle.jcajce.PKIXCRLStore;
import org.bouncycastle.util.CollectionStore;

class CrlCache {
  private static final int DEFAULT_TIMEOUT = 15000;
  
  private static Map<URI, WeakReference<PKIXCRLStore>> cache = Collections.synchronizedMap(new WeakHashMap());
  
  static PKIXCRLStore getCrl(CertificateFactory paramCertificateFactory, Date paramDate, URI paramURI) throws IOException, CRLException {
    Collection collection;
    PKIXCRLStore pKIXCRLStore = null;
    WeakReference weakReference = (WeakReference)cache.get(paramURI);
    if (weakReference != null)
      pKIXCRLStore = (PKIXCRLStore)weakReference.get(); 
    if (pKIXCRLStore != null) {
      boolean bool = false;
      for (X509CRL x509CRL : pKIXCRLStore.getMatches(null)) {
        Date date = x509CRL.getNextUpdate();
        if (date != null && date.before(paramDate)) {
          bool = true;
          break;
        } 
      } 
      if (!bool)
        return pKIXCRLStore; 
    } 
    if (paramURI.getScheme().equals("ldap")) {
      collection = getCrlsFromLDAP(paramCertificateFactory, paramURI);
    } else {
      collection = getCrls(paramCertificateFactory, paramURI);
    } 
    LocalCRLStore localCRLStore = new LocalCRLStore(new CollectionStore(collection));
    cache.put(paramURI, new WeakReference(localCRLStore));
    return localCRLStore;
  }
  
  private static Collection getCrlsFromLDAP(CertificateFactory paramCertificateFactory, URI paramURI) throws IOException, CRLException {
    Hashtable hashtable = new Hashtable();
    hashtable.put("java.naming.factory.initial", "com.sun.jndi.ldap.LdapCtxFactory");
    hashtable.put("java.naming.provider.url", paramURI.toString());
    byte[] arrayOfByte = null;
    try {
      InitialDirContext initialDirContext = new InitialDirContext((Hashtable)hashtable);
      Attributes attributes = initialDirContext.getAttributes("");
      Attribute attribute = attributes.get("certificateRevocationList;binary");
      arrayOfByte = (byte[])attribute.get();
    } catch (NamingException namingException) {
      throw new CRLException("issue connecting to: " + paramURI.toString(), namingException);
    } 
    if (arrayOfByte == null || arrayOfByte.length == 0)
      throw new CRLException("no CRL returned from: " + paramURI); 
    return paramCertificateFactory.generateCRLs(new ByteArrayInputStream(arrayOfByte));
  }
  
  private static Collection getCrls(CertificateFactory paramCertificateFactory, URI paramURI) throws IOException, CRLException {
    HttpURLConnection httpURLConnection = (HttpURLConnection)paramURI.toURL().openConnection();
    httpURLConnection.setConnectTimeout(15000);
    httpURLConnection.setReadTimeout(15000);
    InputStream inputStream = httpURLConnection.getInputStream();
    Collection collection = paramCertificateFactory.generateCRLs(inputStream);
    inputStream.close();
    return collection;
  }
}
