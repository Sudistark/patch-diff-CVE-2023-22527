package org.bouncycastle.crypto.digests;

import java.util.Enumeration;
import java.util.Hashtable;
import java.util.Vector;
import org.bouncycastle.crypto.OutputLengthException;
import org.bouncycastle.crypto.engines.ThreefishEngine;
import org.bouncycastle.crypto.params.SkeinParameters;
import org.bouncycastle.util.Arrays;
import org.bouncycastle.util.Integers;
import org.bouncycastle.util.Memoable;

public class SkeinEngine implements Memoable {
  public static final int SKEIN_256 = 256;
  
  public static final int SKEIN_512 = 512;
  
  public static final int SKEIN_1024 = 1024;
  
  private static final int PARAM_TYPE_KEY = 0;
  
  private static final int PARAM_TYPE_CONFIG = 4;
  
  private static final int PARAM_TYPE_MESSAGE = 48;
  
  private static final int PARAM_TYPE_OUTPUT = 63;
  
  private static final Hashtable INITIAL_STATES = new Hashtable();
  
  final ThreefishEngine threefish;
  
  private final int outputSizeBytes;
  
  long[] chain;
  
  private long[] initialState;
  
  private byte[] key;
  
  private Parameter[] preMessageParameters;
  
  private Parameter[] postMessageParameters;
  
  private final UBI ubi;
  
  private final byte[] singleByte = new byte[1];
  
  private static void initialState(int paramInt1, int paramInt2, long[] paramArrayOfLong) { INITIAL_STATES.put(variantIdentifier(paramInt1 / 8, paramInt2 / 8), paramArrayOfLong); }
  
  private static Integer variantIdentifier(int paramInt1, int paramInt2) { return Integers.valueOf(paramInt2 << 16 | paramInt1); }
  
  public SkeinEngine(int paramInt1, int paramInt2) {
    if (paramInt2 % 8 != 0)
      throw new IllegalArgumentException("Output size must be a multiple of 8 bits. :" + paramInt2); 
    this.outputSizeBytes = paramInt2 / 8;
    this.threefish = new ThreefishEngine(paramInt1);
    this.ubi = new UBI(this, this.threefish.getBlockSize());
  }
  
  public SkeinEngine(SkeinEngine paramSkeinEngine) {
    this(paramSkeinEngine.getBlockSize() * 8, paramSkeinEngine.getOutputSize() * 8);
    copyIn(paramSkeinEngine);
  }
  
  private void copyIn(SkeinEngine paramSkeinEngine) {
    this.ubi.reset(paramSkeinEngine.ubi);
    this.chain = Arrays.clone(paramSkeinEngine.chain, this.chain);
    this.initialState = Arrays.clone(paramSkeinEngine.initialState, this.initialState);
    this.key = Arrays.clone(paramSkeinEngine.key, this.key);
    this.preMessageParameters = clone(paramSkeinEngine.preMessageParameters, this.preMessageParameters);
    this.postMessageParameters = clone(paramSkeinEngine.postMessageParameters, this.postMessageParameters);
  }
  
  private static Parameter[] clone(Parameter[] paramArrayOfParameter1, Parameter[] paramArrayOfParameter2) {
    if (paramArrayOfParameter1 == null)
      return null; 
    if (paramArrayOfParameter2 == null || paramArrayOfParameter2.length != paramArrayOfParameter1.length)
      paramArrayOfParameter2 = new Parameter[paramArrayOfParameter1.length]; 
    System.arraycopy(paramArrayOfParameter1, 0, paramArrayOfParameter2, 0, paramArrayOfParameter2.length);
    return paramArrayOfParameter2;
  }
  
  public Memoable copy() { return new SkeinEngine(this); }
  
  public void reset(Memoable paramMemoable) {
    SkeinEngine skeinEngine = (SkeinEngine)paramMemoable;
    if (getBlockSize() != skeinEngine.getBlockSize() || this.outputSizeBytes != skeinEngine.outputSizeBytes)
      throw new IllegalArgumentException("Incompatible parameters in provided SkeinEngine."); 
    copyIn(skeinEngine);
  }
  
  public int getOutputSize() { return this.outputSizeBytes; }
  
  public int getBlockSize() { return this.threefish.getBlockSize(); }
  
  public void init(SkeinParameters paramSkeinParameters) {
    this.chain = null;
    this.key = null;
    this.preMessageParameters = null;
    this.postMessageParameters = null;
    if (paramSkeinParameters != null) {
      byte[] arrayOfByte = paramSkeinParameters.getKey();
      if (arrayOfByte.length < 16)
        throw new IllegalArgumentException("Skein key must be at least 128 bits."); 
      initParams(paramSkeinParameters.getParameters());
    } 
    createInitialState();
    ubiInit(48);
  }
  
  private void initParams(Hashtable paramHashtable) {
    Enumeration enumeration = paramHashtable.keys();
    Vector vector1 = new Vector();
    Vector vector2 = new Vector();
    while (enumeration.hasMoreElements()) {
      Integer integer = (Integer)enumeration.nextElement();
      byte[] arrayOfByte = (byte[])paramHashtable.get(integer);
      if (integer.intValue() == 0) {
        this.key = arrayOfByte;
        continue;
      } 
      if (integer.intValue() < 48) {
        vector1.addElement(new Parameter(integer.intValue(), arrayOfByte));
        continue;
      } 
      vector2.addElement(new Parameter(integer.intValue(), arrayOfByte));
    } 
    this.preMessageParameters = new Parameter[vector1.size()];
    vector1.copyInto(this.preMessageParameters);
    sort(this.preMessageParameters);
    this.postMessageParameters = new Parameter[vector2.size()];
    vector2.copyInto(this.postMessageParameters);
    sort(this.postMessageParameters);
  }
  
  private static void sort(Parameter[] paramArrayOfParameter) {
    if (paramArrayOfParameter == null)
      return; 
    for (byte b = 1; b < paramArrayOfParameter.length; b++) {
      Parameter parameter = paramArrayOfParameter[b];
      byte b1;
      for (b1 = b; b1 && parameter.getType() < paramArrayOfParameter[b1 - true].getType(); b1--)
        paramArrayOfParameter[b1] = paramArrayOfParameter[b1 - true]; 
      paramArrayOfParameter[b1] = parameter;
    } 
  }
  
  private void createInitialState() {
    long[] arrayOfLong = (long[])INITIAL_STATES.get(variantIdentifier(getBlockSize(), getOutputSize()));
    if (this.key == null && arrayOfLong != null) {
      this.chain = Arrays.clone(arrayOfLong);
    } else {
      this.chain = new long[getBlockSize() / 8];
      if (this.key != null)
        ubiComplete(0, this.key); 
      ubiComplete(4, (new Configuration((this.outputSizeBytes * 8))).getBytes());
    } 
    if (this.preMessageParameters != null)
      for (byte b = 0; b < this.preMessageParameters.length; b++) {
        Parameter parameter = this.preMessageParameters[b];
        ubiComplete(parameter.getType(), parameter.getValue());
      }  
    this.initialState = Arrays.clone(this.chain);
  }
  
  public void reset() {
    System.arraycopy(this.initialState, 0, this.chain, 0, this.chain.length);
    ubiInit(48);
  }
  
  private void ubiComplete(int paramInt, byte[] paramArrayOfByte) {
    ubiInit(paramInt);
    this.ubi.update(paramArrayOfByte, 0, paramArrayOfByte.length, this.chain);
    ubiFinal();
  }
  
  private void ubiInit(int paramInt) { this.ubi.reset(paramInt); }
  
  private void ubiFinal() { this.ubi.doFinal(this.chain); }
  
  private void checkInitialised() {
    if (this.ubi == null)
      throw new IllegalArgumentException("Skein engine is not initialised."); 
  }
  
  public void update(byte paramByte) {
    this.singleByte[0] = paramByte;
    update(this.singleByte, 0, 1);
  }
  
  public void update(byte[] paramArrayOfByte, int paramInt1, int paramInt2) {
    checkInitialised();
    this.ubi.update(paramArrayOfByte, paramInt1, paramInt2, this.chain);
  }
  
  public int doFinal(byte[] paramArrayOfByte, int paramInt) {
    checkInitialised();
    if (paramArrayOfByte.length < paramInt + this.outputSizeBytes)
      throw new OutputLengthException("Output buffer is too short to hold output"); 
    ubiFinal();
    if (this.postMessageParameters != null)
      for (byte b = 0; b < this.postMessageParameters.length; b++) {
        Parameter parameter = this.postMessageParameters[b];
        ubiComplete(parameter.getType(), parameter.getValue());
      }  
    int i = getBlockSize();
    int j = (this.outputSizeBytes + i - 1) / i;
    for (int k = 0; k < j; k++) {
      int m = Math.min(i, this.outputSizeBytes - k * i);
      output(k, paramArrayOfByte, paramInt + k * i, m);
    } 
    reset();
    return this.outputSizeBytes;
  }
  
  private void output(long paramLong, byte[] paramArrayOfByte, int paramInt1, int paramInt2) {
    byte[] arrayOfByte = new byte[8];
    ThreefishEngine.wordToBytes(paramLong, arrayOfByte, 0);
    long[] arrayOfLong = new long[this.chain.length];
    ubiInit(63);
    this.ubi.update(arrayOfByte, 0, arrayOfByte.length, arrayOfLong);
    this.ubi.doFinal(arrayOfLong);
    int i = (paramInt2 + 8 - 1) / 8;
    for (byte b = 0; b < i; b++) {
      int j = Math.min(8, paramInt2 - b * 8);
      if (j == 8) {
        ThreefishEngine.wordToBytes(arrayOfLong[b], paramArrayOfByte, paramInt1 + b * 8);
      } else {
        ThreefishEngine.wordToBytes(arrayOfLong[b], arrayOfByte, 0);
        System.arraycopy(arrayOfByte, 0, paramArrayOfByte, paramInt1 + b * 8, j);
      } 
    } 
  }
  
  static  {
    initialState(256, 128, new long[] { -2228972824489528736L, -8629553674646093540L, 1155188648486244218L, -3677226592081559102L });
    initialState(256, 160, new long[] { 1450197650740764312L, 3081844928540042640L, -3136097061834271170L, 3301952811952417661L });
    initialState(256, 224, new long[] { -4176654842910610933L, -8688192972455077604L, -7364642305011795836L, 4056579644589979102L });
    initialState(256, 256, new long[] { -243853671043386295L, 3443677322885453875L, -5531612722399640561L, 7662005193972177513L });
    initialState(512, 128, new long[] { -6288014694233956526L, 2204638249859346602L, 3502419045458743507L, -4829063503441264548L, 983504137758028059L, 1880512238245786339L, -6715892782214108542L, 7602827311880509485L });
    initialState(512, 160, new long[] { 2934123928682216849L, -4399710721982728305L, 1684584802963255058L, 5744138295201861711L, 2444857010922934358L, -2807833639722848072L, -5121587834665610502L, 118355523173251694L });
    initialState(512, 224, new long[] { -3688341020067007964L, -3772225436291745297L, -8300862168937575580L, 4146387520469897396L, 1106145742801415120L, 7455425944880474941L, -7351063101234211863L, -7048981346965512457L });
    initialState(512, 384, new long[] { -6631894876634615969L, -5692838220127733084L, -7099962856338682626L, -2911352911530754598L, 2000907093792408677L, 9140007292425499655L, 6093301768906360022L, 2769176472213098488L });
    initialState(512, 512, new long[] { 5261240102383538638L, 978932832955457283L, -8083517948103779378L, -7339365279355032399L, 6752626034097301424L, -1531723821829733388L, -7417126464950782685L, -5901786942805128141L });
  }
}
