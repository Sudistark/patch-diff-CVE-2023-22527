package org.bouncycastle.crypto.engines;

import org.bouncycastle.crypto.CipherParameters;
import org.bouncycastle.crypto.modes.GCFBBlockCipher;
import org.bouncycastle.crypto.params.KeyParameter;
import org.bouncycastle.crypto.params.ParametersWithIV;
import org.bouncycastle.crypto.params.ParametersWithRandom;
import org.bouncycastle.crypto.params.ParametersWithSBox;
import org.bouncycastle.crypto.params.ParametersWithUKM;
import org.bouncycastle.util.Pack;

public class CryptoProWrapEngine extends GOST28147WrapEngine {
  public void init(boolean paramBoolean, CipherParameters paramCipherParameters) {
    if (paramCipherParameters instanceof ParametersWithRandom) {
      ParametersWithRandom parametersWithRandom = (ParametersWithRandom)paramCipherParameters;
      paramCipherParameters = parametersWithRandom.getParameters();
    } 
    ParametersWithUKM parametersWithUKM = (ParametersWithUKM)paramCipherParameters;
    byte[] arrayOfByte = null;
    if (parametersWithUKM.getParameters() instanceof ParametersWithSBox) {
      keyParameter = (KeyParameter)((ParametersWithSBox)parametersWithUKM.getParameters()).getParameters();
      arrayOfByte = ((ParametersWithSBox)parametersWithUKM.getParameters()).getSBox();
    } else {
      keyParameter = (KeyParameter)parametersWithUKM.getParameters();
    } 
    KeyParameter keyParameter = new KeyParameter(cryptoProDiversify(keyParameter.getKey(), parametersWithUKM.getUKM(), arrayOfByte));
    if (arrayOfByte != null) {
      super.init(paramBoolean, new ParametersWithUKM(new ParametersWithSBox(keyParameter, arrayOfByte), parametersWithUKM.getUKM()));
    } else {
      super.init(paramBoolean, new ParametersWithUKM(keyParameter, parametersWithUKM.getUKM()));
    } 
  }
  
  private static byte[] cryptoProDiversify(byte[] paramArrayOfByte1, byte[] paramArrayOfByte2, byte[] paramArrayOfByte3) {
    for (byte b = 0; b != 8; b++) {
      int i = 0;
      int j = 0;
      for (byte b1 = 0; b1 != 8; b1++) {
        int k = Pack.littleEndianToInt(paramArrayOfByte1, b1 * 4);
        if (bitSet(paramArrayOfByte2[b], b1)) {
          i += k;
        } else {
          j += k;
        } 
      } 
      byte[] arrayOfByte = new byte[8];
      Pack.intToLittleEndian(i, arrayOfByte, 0);
      Pack.intToLittleEndian(j, arrayOfByte, 4);
      GCFBBlockCipher gCFBBlockCipher = new GCFBBlockCipher(new GOST28147Engine());
      gCFBBlockCipher.init(true, new ParametersWithIV(new ParametersWithSBox(new KeyParameter(paramArrayOfByte1), paramArrayOfByte3), arrayOfByte));
      gCFBBlockCipher.processBlock(paramArrayOfByte1, 0, paramArrayOfByte1, 0);
      gCFBBlockCipher.processBlock(paramArrayOfByte1, 8, paramArrayOfByte1, 8);
      gCFBBlockCipher.processBlock(paramArrayOfByte1, 16, paramArrayOfByte1, 16);
      gCFBBlockCipher.processBlock(paramArrayOfByte1, 24, paramArrayOfByte1, 24);
    } 
    return paramArrayOfByte1;
  }
  
  private static boolean bitSet(byte paramByte, int paramInt) { return ((paramByte & 1 << paramInt) != 0); }
}
