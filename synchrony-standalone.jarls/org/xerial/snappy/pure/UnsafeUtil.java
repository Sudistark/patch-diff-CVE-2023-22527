package org.xerial.snappy.pure;

import java.lang.reflect.Field;
import java.nio.Buffer;
import org.xerial.snappy.SnappyError;
import org.xerial.snappy.SnappyErrorCode;
import sun.misc.Unsafe;

final class UnsafeUtil {
  public static final Unsafe UNSAFE;
  
  private static final Field ADDRESS_ACCESSOR;
  
  static  {
    try {
      Field field = Unsafe.class.getDeclaredField("theUnsafe");
      field.setAccessible(true);
      UNSAFE = (Unsafe)field.get(null);
    } catch (Exception exception) {
      throw new SnappyError(SnappyErrorCode.UNSUPPORTED_PLATFORM, "pure-java snappy requires access to sun.misc.Unsafe");
    } 
    try {
      Field field = Buffer.class.getDeclaredField("address");
      field.setAccessible(true);
      ADDRESS_ACCESSOR = field;
    } catch (Exception exception) {
      throw new SnappyError(SnappyErrorCode.UNSUPPORTED_PLATFORM, "pure-java snappy requires access to java.nio.Buffer raw address field");
    } 
  }
  
  public static long getAddress(Buffer paramBuffer) {
    try {
      return ((Long)ADDRESS_ACCESSOR.get(paramBuffer)).longValue();
    } catch (IllegalAccessException illegalAccessException) {
      throw new RuntimeException(illegalAccessException);
    } 
  }
}
