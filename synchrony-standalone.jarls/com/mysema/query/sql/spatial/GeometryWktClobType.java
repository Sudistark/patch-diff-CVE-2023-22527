package com.mysema.query.sql.spatial;

import com.mysema.query.sql.types.AbstractType;
import java.sql.Clob;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import javax.annotation.Nullable;
import org.geolatte.geom.Geometry;
import org.geolatte.geom.codec.Wkt;

public class GeometryWktClobType extends AbstractType<Geometry> {
  public static final GeometryWktClobType DEFAULT = new GeometryWktClobType();
  
  public GeometryWktClobType() { super(2005); }
  
  public Class<Geometry> getReturnedClass() { return Geometry.class; }
  
  @Nullable
  public Geometry getValue(ResultSet rs, int startIndex) throws SQLException {
    Clob clob = rs.getClob(startIndex);
    String str = (clob != null) ? clob.getSubString(1L, (int)clob.length()) : null;
    if (str != null)
      return Wkt.newDecoder(Wkt.Dialect.POSTGIS_EWKT_1).decode(str); 
    return null;
  }
  
  public void setValue(PreparedStatement st, int startIndex, Geometry value) throws SQLException {
    String str = Wkt.newEncoder(Wkt.Dialect.POSTGIS_EWKT_1).encode(value);
    st.setString(startIndex, str);
  }
  
  public String getLiteral(Geometry geometry) { return "'" + Wkt.newEncoder(Wkt.Dialect.POSTGIS_EWKT_1).encode(geometry) + "'"; }
}
