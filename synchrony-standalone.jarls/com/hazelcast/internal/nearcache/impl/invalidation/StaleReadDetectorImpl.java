package com.hazelcast.internal.nearcache.impl.invalidation;

import com.hazelcast.internal.nearcache.NearCacheRecord;

public class StaleReadDetectorImpl implements StaleReadDetector {
  private final RepairingHandler repairingHandler;
  
  private final MinimalPartitionService partitionService;
  
  StaleReadDetectorImpl(RepairingHandler repairingHandler, MinimalPartitionService partitionService) {
    this.repairingHandler = repairingHandler;
    this.partitionService = partitionService;
  }
  
  public boolean isStaleRead(Object key, NearCacheRecord record) {
    MetaDataContainer latestMetaData = this.repairingHandler.getMetaDataContainer(record.getPartitionId());
    return (!record.hasSameUuid(latestMetaData.getUuid()) || record
      .getInvalidationSequence() < latestMetaData.getStaleSequence());
  }
  
  public int getPartitionId(Object key) { return this.partitionService.getPartitionId(key); }
  
  public MetaDataContainer getMetaDataContainer(int partitionId) { return this.repairingHandler.getMetaDataContainer(partitionId); }
  
  public String toString() { return "Default StaleReadDetectorImpl"; }
}
