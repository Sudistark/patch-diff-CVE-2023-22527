package com.hazelcast.flakeidgen.impl;

public class AutoBatcher {
  private final int batchSize;
  
  private final long validity;
  
  private final IdBatchSupplier batchIdSupplier;
  
  public AutoBatcher(int batchSize, long validity, IdBatchSupplier idGenerator) {
    this.block = new Block(new IdBatch(0L, 0L, 0), 0L, null);
    this.batchSize = batchSize;
    this.validity = validity;
    this.batchIdSupplier = idGenerator;
  }
  
  public long newId() {
    while (true) {
      Block block = this.block;
      long res = block.next();
      if (res != Float.MIN_VALUE)
        return res; 
      synchronized (this) {
        if (block != this.block)
          continue; 
        this.block = new Block(this.batchIdSupplier.newIdBatch(this.batchSize), this.validity, null);
      } 
    } 
  }
}
