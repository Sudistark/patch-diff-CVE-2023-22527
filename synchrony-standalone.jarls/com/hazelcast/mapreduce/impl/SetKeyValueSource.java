package com.hazelcast.mapreduce.impl;

import com.hazelcast.collection.impl.collection.CollectionItem;
import com.hazelcast.collection.impl.set.SetContainer;
import com.hazelcast.collection.impl.set.SetService;
import com.hazelcast.internal.partition.InternalPartitionService;
import com.hazelcast.mapreduce.KeyValueSource;
import com.hazelcast.nio.Address;
import com.hazelcast.nio.ObjectDataInput;
import com.hazelcast.nio.ObjectDataOutput;
import com.hazelcast.nio.serialization.BinaryInterface;
import com.hazelcast.nio.serialization.Data;
import com.hazelcast.nio.serialization.IdentifiedDataSerializable;
import com.hazelcast.partition.strategy.StringAndPartitionAwarePartitioningStrategy;
import com.hazelcast.spi.NodeEngine;
import com.hazelcast.spi.impl.NodeEngineImpl;
import com.hazelcast.spi.serialization.SerializationService;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

@BinaryInterface
public class SetKeyValueSource<V> extends KeyValueSource<String, V> implements IdentifiedDataSerializable {
  private final MapReduceSimpleEntry<String, V> simpleEntry = new MapReduceSimpleEntry();
  
  private String setName;
  
  private SerializationService ss;
  
  private Iterator<CollectionItem> iterator;
  
  private CollectionItem nextElement;
  
  public SetKeyValueSource(String setName) { this.setName = setName; }
  
  public String getSetName() { return this.setName; }
  
  public boolean open(NodeEngine nodeEngine) {
    NodeEngineImpl nei = (NodeEngineImpl)nodeEngine;
    this.ss = nei.getSerializationService();
    Address thisAddress = nei.getThisAddress();
    InternalPartitionService ps = nei.getPartitionService();
    Data data = this.ss.toData(this.setName, StringAndPartitionAwarePartitioningStrategy.INSTANCE);
    int partitionId = ps.getPartitionId(data);
    Address partitionOwner = ps.getPartitionOwner(partitionId);
    if (partitionOwner == null)
      return false; 
    if (thisAddress.equals(partitionOwner)) {
      SetService setService = (SetService)nei.getService("hz:impl:setService");
      SetContainer setContainer = setService.getOrCreateContainer(this.setName, false);
      List<CollectionItem> items = new ArrayList<CollectionItem>(setContainer.getCollection());
      this.iterator = items.iterator();
    } 
    return true;
  }
  
  public boolean hasNext() {
    boolean hasNext = (this.iterator == null) ? false : this.iterator.hasNext();
    this.nextElement = hasNext ? (CollectionItem)this.iterator.next() : null;
    return hasNext;
  }
  
  public String key() { return this.setName; }
  
  public Map.Entry<String, V> element() {
    Object value = this.nextElement.getValue();
    if (value != null)
      value = this.ss.toObject(value); 
    this.simpleEntry.setKey(this.setName);
    this.simpleEntry.setValue(value);
    return this.simpleEntry;
  }
  
  public boolean reset() {
    this.iterator = null;
    this.nextElement = null;
    return true;
  }
  
  public void close() {
    this.iterator = null;
    this.nextElement = null;
  }
  
  public void writeData(ObjectDataOutput out) throws IOException { out.writeUTF(this.setName); }
  
  public void readData(ObjectDataInput in) throws IOException { this.setName = in.readUTF(); }
  
  public int getFactoryId() { return MapReduceDataSerializerHook.F_ID; }
  
  public int getId() { return 19; }
  
  public SetKeyValueSource() {}
}
