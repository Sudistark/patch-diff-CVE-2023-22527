package com.hazelcast.spi.impl.eventservice.impl.operations;

import com.hazelcast.internal.cluster.ClusterService;
import com.hazelcast.internal.cluster.impl.ClusterTopologyChangedException;
import com.hazelcast.nio.ObjectDataInput;
import com.hazelcast.nio.ObjectDataOutput;
import com.hazelcast.nio.serialization.IdentifiedDataSerializable;
import com.hazelcast.nio.serialization.impl.Versioned;
import com.hazelcast.spi.ExceptionAction;
import com.hazelcast.spi.Operation;
import com.hazelcast.spi.impl.AllowedDuringPassiveState;
import com.hazelcast.spi.impl.SpiDataSerializerHook;
import java.io.IOException;

abstract class AbstractRegistrationOperation extends Operation implements AllowedDuringPassiveState, IdentifiedDataSerializable, Versioned {
  private int memberListVersion = -1;
  
  AbstractRegistrationOperation() {}
  
  AbstractRegistrationOperation(int memberListVersion) { this.memberListVersion = memberListVersion; }
  
  public final void run() {
    runInternal();
    checkMemberListVersion();
  }
  
  protected abstract void runInternal();
  
  private void checkMemberListVersion() {
    ClusterService clusterService = getNodeEngine().getClusterService();
    if (clusterService.isMaster()) {
      int currentMemberListVersion = clusterService.getMemberListVersion();
      if (currentMemberListVersion != this.memberListVersion)
        throw new ClusterTopologyChangedException(
            String.format("Current member list version %d does not match expected %d", new Object[] { Integer.valueOf(currentMemberListVersion), 
                Integer.valueOf(this.memberListVersion) })); 
    } 
  }
  
  protected final void writeInternal(ObjectDataOutput out) throws IOException {
    out.writeInt(this.memberListVersion);
    writeInternalImpl(out);
  }
  
  protected abstract void writeInternalImpl(ObjectDataOutput paramObjectDataOutput) throws IOException;
  
  protected final void readInternal(ObjectDataInput in) throws IOException {
    this.memberListVersion = in.readInt();
    readInternalImpl(in);
  }
  
  protected abstract void readInternalImpl(ObjectDataInput paramObjectDataInput) throws IOException;
  
  public ExceptionAction onInvocationException(Throwable throwable) { return (throwable instanceof ClusterTopologyChangedException) ? ExceptionAction.THROW_EXCEPTION : super
      
      .onInvocationException(throwable); }
  
  public int getFactoryId() { return SpiDataSerializerHook.F_ID; }
}
