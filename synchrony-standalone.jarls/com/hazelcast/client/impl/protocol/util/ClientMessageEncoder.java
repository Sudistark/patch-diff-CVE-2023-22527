package com.hazelcast.client.impl.protocol.util;

import com.hazelcast.client.impl.protocol.ClientMessage;
import com.hazelcast.internal.networking.HandlerStatus;
import com.hazelcast.internal.networking.OutboundHandler;
import com.hazelcast.nio.IOUtil;
import com.hazelcast.util.function.Supplier;
import java.nio.ByteBuffer;

public class ClientMessageEncoder extends OutboundHandler<Supplier<ClientMessage>, ByteBuffer> {
  private ClientMessage message;
  
  public void handlerAdded() { initDstBuffer(); }
  
  public HandlerStatus onWrite() {
    IOUtil.compactOrClear((ByteBuffer)this.dst);
    try {
      while (true) {
        if (this.message == null) {
          this.message = (ClientMessage)((Supplier)this.src).get();
          if (this.message == null)
            return HandlerStatus.CLEAN; 
        } 
        if (this.message.writeTo((ByteBuffer)this.dst)) {
          this.message = null;
          continue;
        } 
        break;
      } 
      return HandlerStatus.DIRTY;
    } finally {
      ((ByteBuffer)this.dst).flip();
    } 
  }
}
