package com.hazelcast.replicatedmap.impl.record;

import java.lang.reflect.Array;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

class LazyCollection<K, V> extends Object implements Collection<V> {
  private final InternalReplicatedMapStorage<K, V> storage;
  
  private final LazySet.IteratorFactory<K, V, V> iteratorFactory;
  
  private final Collection<ReplicatedRecord<K, V>> values;
  
  public LazyCollection(LazySet.IteratorFactory<K, V, V> iteratorFactory, InternalReplicatedMapStorage<K, V> storage) {
    this.iteratorFactory = iteratorFactory;
    this.values = storage.values();
    this.storage = storage;
  }
  
  public int size() { return this.values.size(); }
  
  public boolean isEmpty() { return this.values.isEmpty(); }
  
  public boolean contains(Object value) { throw new UnsupportedOperationException("LazySet does not support contains requests"); }
  
  public Iterator<V> iterator() {
    Iterator<Map.Entry<K, ReplicatedRecord<K, V>>> iterator = this.storage.entrySet().iterator();
    return this.iteratorFactory.create(iterator);
  }
  
  public Object[] toArray() {
    List<Object> result = new ArrayList<Object>(this.storage.values().size());
    Iterator<V> iterator = iterator();
    while (iterator.hasNext())
      result.add(iterator.next()); 
    return result.toArray(new Object[0]);
  }
  
  public <T> T[] toArray(T[] a) {
    List<Object> result = new ArrayList<Object>(this.storage.values().size());
    Iterator<V> iterator = iterator();
    while (iterator.hasNext())
      result.add(iterator.next()); 
    if (a.length != result.size())
      a = (T[])(Object[])Array.newInstance(a.getClass().getComponentType(), result.size()); 
    for (int i = 0; i < a.length; i++)
      a[i] = result.get(i); 
    return a;
  }
  
  public boolean add(V v) { throw new UnsupportedOperationException("LazyList is not modifiable"); }
  
  public boolean remove(Object o) { throw new UnsupportedOperationException("LazyList is not modifiable"); }
  
  public boolean containsAll(Collection<?> c) { throw new UnsupportedOperationException("LazySet does not support contains requests"); }
  
  public boolean addAll(Collection<? extends V> c) { throw new UnsupportedOperationException("LazyList is not modifiable"); }
  
  public boolean removeAll(Collection<?> c) { throw new UnsupportedOperationException("LazyList is not modifiable"); }
  
  public boolean retainAll(Collection<?> c) { throw new UnsupportedOperationException("LazyList is not modifiable"); }
  
  public void clear() { throw new UnsupportedOperationException("LazyList is not modifiable"); }
}
