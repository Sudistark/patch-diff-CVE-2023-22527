package org.bouncycastle.jcajce;

import java.math.BigInteger;
import java.security.cert.CRL;
import java.security.cert.CRLSelector;
import java.security.cert.CertStore;
import java.security.cert.CertStoreException;
import java.security.cert.X509CRL;
import java.security.cert.X509CRLSelector;
import java.security.cert.X509Certificate;
import java.util.Collection;
import org.bouncycastle.asn1.ASN1Integer;
import org.bouncycastle.asn1.ASN1OctetString;
import org.bouncycastle.asn1.x509.Extension;
import org.bouncycastle.util.Arrays;
import org.bouncycastle.util.Selector;

public class PKIXCRLStoreSelector<T extends CRL> extends Object implements Selector<T> {
  private final CRLSelector baseSelector;
  
  private final boolean deltaCRLIndicator;
  
  private final boolean completeCRLEnabled;
  
  private final BigInteger maxBaseCRLNumber;
  
  private final byte[] issuingDistributionPoint;
  
  private final boolean issuingDistributionPointEnabled;
  
  private PKIXCRLStoreSelector(Builder baseBuilder) {
    this.baseSelector = Builder.access$100(baseBuilder);
    this.deltaCRLIndicator = Builder.access$200(baseBuilder);
    this.completeCRLEnabled = Builder.access$300(baseBuilder);
    this.maxBaseCRLNumber = Builder.access$400(baseBuilder);
    this.issuingDistributionPoint = Builder.access$500(baseBuilder);
    this.issuingDistributionPointEnabled = Builder.access$600(baseBuilder);
  }
  
  public boolean isIssuingDistributionPointEnabled() { return this.issuingDistributionPointEnabled; }
  
  public boolean match(CRL obj) {
    if (!(obj instanceof X509CRL))
      return this.baseSelector.match(obj); 
    X509CRL crl = (X509CRL)obj;
    ASN1Integer dci = null;
    try {
      byte[] bytes = crl.getExtensionValue(Extension.deltaCRLIndicator.getId());
      if (bytes != null)
        dci = ASN1Integer.getInstance(ASN1OctetString.getInstance(bytes).getOctets()); 
    } catch (Exception e) {
      return false;
    } 
    if (isDeltaCRLIndicatorEnabled())
      if (dci == null)
        return false;  
    if (isCompleteCRLEnabled())
      if (dci != null)
        return false;  
    if (dci != null)
      if (this.maxBaseCRLNumber != null)
        if (dci.getPositiveValue().compareTo(this.maxBaseCRLNumber) == 1)
          return false;   
    if (this.issuingDistributionPointEnabled) {
      byte[] idp = crl.getExtensionValue(Extension.issuingDistributionPoint
          .getId());
      if (this.issuingDistributionPoint == null) {
        if (idp != null)
          return false; 
      } else if (!Arrays.areEqual(idp, this.issuingDistributionPoint)) {
        return false;
      } 
    } 
    return this.baseSelector.match(obj);
  }
  
  public boolean isDeltaCRLIndicatorEnabled() { return this.deltaCRLIndicator; }
  
  public Object clone() { return this; }
  
  public boolean isCompleteCRLEnabled() { return this.completeCRLEnabled; }
  
  public BigInteger getMaxBaseCRLNumber() { return this.maxBaseCRLNumber; }
  
  public byte[] getIssuingDistributionPoint() { return Arrays.clone(this.issuingDistributionPoint); }
  
  public X509Certificate getCertificateChecking() {
    if (this.baseSelector instanceof X509CRLSelector)
      return ((X509CRLSelector)this.baseSelector).getCertificateChecking(); 
    return null;
  }
  
  public static Collection<? extends CRL> getCRLs(PKIXCRLStoreSelector selector, CertStore certStore) throws CertStoreException { return certStore.getCRLs(new SelectorClone(selector)); }
}
