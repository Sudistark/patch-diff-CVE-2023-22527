package org.bouncycastle.asn1;

import java.io.IOException;
import java.io.InputStream;

class ConstructedBitStream extends InputStream {
  private final ASN1StreamParser _parser;
  
  private final boolean _octetAligned;
  
  private boolean _first;
  
  private int _padBits;
  
  private ASN1BitStringParser _currentParser;
  
  private InputStream _currentStream;
  
  ConstructedBitStream(ASN1StreamParser parser, boolean octetAligned) {
    this._first = true;
    this._padBits = 0;
    this._parser = parser;
    this._octetAligned = octetAligned;
  }
  
  int getPadBits() { return this._padBits; }
  
  public int read(byte[] b, int off, int len) throws IOException {
    if (this._currentStream == null) {
      if (!this._first)
        return -1; 
      this._currentParser = getNextParser();
      if (this._currentParser == null)
        return -1; 
      this._first = false;
      this._currentStream = this._currentParser.getBitStream();
    } 
    int totalRead = 0;
    while (true) {
      int numRead = this._currentStream.read(b, off + totalRead, len - totalRead);
      if (numRead >= 0) {
        totalRead += numRead;
        if (totalRead == len)
          return totalRead; 
        continue;
      } 
      this._padBits = this._currentParser.getPadBits();
      this._currentParser = getNextParser();
      if (this._currentParser == null) {
        this._currentStream = null;
        return (totalRead < 1) ? -1 : totalRead;
      } 
      this._currentStream = this._currentParser.getBitStream();
    } 
  }
  
  public int read() {
    if (this._currentStream == null) {
      if (!this._first)
        return -1; 
      this._currentParser = getNextParser();
      if (this._currentParser == null)
        return -1; 
      this._first = false;
      this._currentStream = this._currentParser.getBitStream();
    } 
    while (true) {
      int b = this._currentStream.read();
      if (b >= 0)
        return b; 
      this._padBits = this._currentParser.getPadBits();
      this._currentParser = getNextParser();
      if (this._currentParser == null) {
        this._currentStream = null;
        return -1;
      } 
      this._currentStream = this._currentParser.getBitStream();
    } 
  }
  
  private ASN1BitStringParser getNextParser() throws IOException {
    ASN1Encodable asn1Obj = this._parser.readObject();
    if (asn1Obj == null) {
      if (this._octetAligned && this._padBits != 0)
        throw new IOException("expected octet-aligned bitstring, but found padBits: " + this._padBits); 
      return null;
    } 
    if (asn1Obj instanceof ASN1BitStringParser) {
      if (this._padBits != 0)
        throw new IOException("only the last nested bitstring can have padding"); 
      return (ASN1BitStringParser)asn1Obj;
    } 
    throw new IOException("unknown object encountered: " + asn1Obj.getClass());
  }
}
