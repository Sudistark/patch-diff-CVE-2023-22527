#* @vtlvariable name="allVersions" type="java.util.List<com.atlassian.confluence.core.VersionHistorySummary>" *#
#* @vtlvariable name="showActions" type="boolean" *#
#* @vtlvariable name="isOfflineCollabEditingMode" type="boolean" *#
#* @vtlvariable name="revertPermitted" type="boolean" *#
#* @vtlvariable name="removeHistoricalVersionPermitted" type="boolean" *#
#* @vtlvariable name="showFullPageHistoryLink" type="boolean" *#
#* @vtlvariable name="page" type="com.atlassian.confluence.pages.AbstractPage" *#

##
## Warning! This template is not only used from version history action, but also from the change-history macro.
## If you are adding variables or making other breaking changes, please make sure the macro works (fix it if necessary)
##

#requireResource("confluence.web.resources:page-history")

#macro(contributorAvatarAndName $contributor $divClass)
<div class="$divClass" #if($contributor)data-username="$!contributor.name"#end>
    #userLogoBlock($contributor)
    <span class="page-history-contributor-name">#userLink($contributor)</span>
</div>
#end

#macro(additionalContributorsDialog $additionalContributors $page)
    #if ($additionalContributors.size() > 0)
    <button class="aui-button additional-contributors-button" aria-controls="additional-contributors-$page.id" data-aui-trigger="true">$additionalContributors.size()</button>
    <span class="aui-button aui-button-link additional-contributors-button" aria-controls="additional-contributors-$page.id" data-aui-trigger="true">
        #if($additionalContributors.size() == 1)
            $i18n.getText("view.previous.versions.additional.contributors.one")
        #else
            $i18n.getText("view.previous.versions.additional.contributors", $additionalContributors.size())
        #end
    </span>
    <aui-inline-dialog id="additional-contributors-$page.id"
                       alignment="top left"
                       responds-to="toggle"
                       aria-hidden="true">
        <div class="page-history-additional-contributors-dialog-content">
            #foreach ( $additionalContributor in $additionalContributors)
                #contributorAvatarAndName($additionalContributor, "page-history-additional-contributor-link")
            #end
        </div>
    </aui-inline-dialog>
    #end
#end

<form name="diff" method="GET" action="diffpagesbyversion.action" class="aui">
    #if ($showActions)
        <input type="submit" class="aui-button" value="$i18n.getText('compare.selected')">
        <input type="hidden" name="pageId" value="$page.id">
    #end

    <style>
        .tableview td {white-space:nowrap; vertical-align:top;}
    </style>

    <table id="page-history-container" width="100%" cellspacing="0" class="aui tableview">
        <thead>
        <tr>
            #if ($showActions)
                ## This is the column with checkboxes: we don't need them if there are no actions
                <th>&nbsp;</th>
            #end
            <th>$i18n.getText("heading.version.number")</th>
            <th>$i18n.getText("heading.version.date")</th>
            <th>$i18n.getText("heading.contributors")</th>
            <th>$i18n.getText("heading.comment")</th>
            #if ($showActions)
                <th>$i18n.getText("heading.actions")</th>
            #end
        </tr>
        </thead>
        <tbody>
            #foreach( $pageVersion in $allVersions )
            <tr id="rowForVersion$pageVersion.version">
                #if ($showActions)
                    <td width="%1"><input type="checkbox" name="selectedPageVersions" value="$pageVersion.version"></td>
                #end
            ## Version
                <td align="left">
                    #if ($velocityCount == 1)
                        <strong>
                            <a href="viewpage.action?pageId=$page.id">$i18n.getText("current.version")</a>
                            (v. $page.version)
                        </strong>
                    #else
                        <a class="view-historical-version-trigger" href="viewpage.action?pageId=${pageVersion.id}">v. $pageVersion.version</a>
                    #end
                </td>
            ## Last modification date
                <td align="middle" #if($velocityCount == 1)  style="font-weight: bold;" #end>
                    $dateFormatter.formatDateTime( $pageVersion.lastModificationDate )
                </td>
            ## Contributors
                <td class="contributors" style="white-space: normal;">
                    #if (!$offlineCollabEditingMode)
                        #set ($additionalContributors = [])
                        #set ($maxContributors = 12)
                        #set ($contributors = $pageVersion.getContributorSet())
                        #foreach( $contributor in $contributors )
                            #if ($contributors.size() > $maxContributors && $velocityCount > $maxContributors)
                                #set ($dummy = $additionalContributors.add($contributor))
                            #else
                                #contributorAvatarAndName($contributor, "page-history-contributor-link")
                            #end
                        #end
                        #additionalContributorsDialog($additionalContributors $pageVersion)
                    #else
                        <strong>#userLink ($pageVersion.lastModifier)</strong>
                    #end
                </td>
            ## Version comment
                <td>
                    #if ($pageVersion.versionCommentAvailable)
                        <span class="change-comment">$pageVersion.renderedVersionComment</span>
                    #end
                </td>
            ## Actions
                #if ($showActions)
                    #if ($velocityCount == 1)
                        <td>&nbsp;</td> ## No operations can be performed on the latest version
                    #else
                        <td align="middle">
                            #if ($revertPermitted)
                                #if ($pageVersion.version > 0)
                                    <a class="restore-historical-version-trigger" href="revertpagebacktoversion.action?pageId=$page.id&version=${pageVersion.version}">$i18n.getText("restore.this.version")</a>
                                #end
                            #end
                            #if ($removeHistoricalVersionPermitted)
                                &nbsp;&nbsp;<a class="remove-historical-version-trigger" data-pageid="$pageVersion.id" data-version="$pageVersion.version" href="#">$i18n.getText("remove.name")</a>
                            #end
                        </td>
                    #end
                #end
            </tr>
            #end
        </tbody>
    </table>
</form>
#if ($showFullPageHistoryLink)
    ## This is here to support the Change History Macro which by default doesn't show everything
    <p><a href="${req.contextPath}/pages/viewpreviousversions.action?pageId=${page.id}" class="aui-button aui-button-link footer-link-to-page-history">$i18n.getText('go.to.page.history')</a></p>
#end
<form id="remove-historical-version-form" name="removehistoricalversion" method="POST" action="removehistoricalversion.action" class="hidden">
    #form_xsrfToken()
    <input id="remove-historical-version-pageid" type="hidden" name="pageId" value="" />
    <input id="remove-historical-version-content-type" type="hidden" name="contentType" value="$page.type" />
</form>