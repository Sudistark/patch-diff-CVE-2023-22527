package org.bouncycastle.crypto.util;

import java.io.IOException;
import java.security.SecureRandom;
import org.bouncycastle.crypto.CryptoServicesRegistrar;
import org.bouncycastle.util.Arrays;

public class JournalingSecureRandom extends SecureRandom {
  private static byte[] EMPTY_TRANSCRIPT = new byte[0];
  
  private final SecureRandom base;
  
  private TranscriptStream tOut;
  
  private byte[] transcript;
  
  private int index;
  
  public JournalingSecureRandom() { this(CryptoServicesRegistrar.getSecureRandom()); }
  
  public JournalingSecureRandom(SecureRandom random) {
    this.tOut = new TranscriptStream(null);
    this.index = 0;
    this.base = random;
    this.transcript = EMPTY_TRANSCRIPT;
  }
  
  public JournalingSecureRandom(byte[] transcript, SecureRandom random) {
    this.tOut = new TranscriptStream(null);
    this.index = 0;
    this.base = random;
    this.transcript = Arrays.clone(transcript);
  }
  
  public final void nextBytes(byte[] bytes) {
    if (this.index >= this.transcript.length) {
      this.base.nextBytes(bytes);
    } else {
      int i = 0;
      while (i != bytes.length) {
        if (this.index < this.transcript.length) {
          bytes[i] = this.transcript[this.index++];
          i++;
        } 
      } 
      if (i != bytes.length) {
        byte[] extra = new byte[bytes.length - i];
        this.base.nextBytes(extra);
        System.arraycopy(extra, 0, bytes, i, extra.length);
      } 
    } 
    try {
      this.tOut.write(bytes);
    } catch (IOException e) {
      throw new IllegalStateException("unable to record transcript: " + e.getMessage());
    } 
  }
  
  public void clear() {
    Arrays.fill(this.transcript, (byte)0);
    this.tOut.clear();
  }
  
  public void reset() {
    this.index = 0;
    if (this.index == this.transcript.length)
      this.transcript = this.tOut.toByteArray(); 
    this.tOut.reset();
  }
  
  public byte[] getTranscript() { return this.tOut.toByteArray(); }
  
  public byte[] getFullTranscript() {
    if (this.index == this.transcript.length)
      return this.tOut.toByteArray(); 
    return Arrays.clone(this.transcript);
  }
}
