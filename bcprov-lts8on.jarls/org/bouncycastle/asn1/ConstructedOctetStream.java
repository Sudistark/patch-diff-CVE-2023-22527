package org.bouncycastle.asn1;

import java.io.IOException;
import java.io.InputStream;

class ConstructedOctetStream extends InputStream {
  private final ASN1StreamParser _parser;
  
  private boolean _first;
  
  private InputStream _currentStream;
  
  ConstructedOctetStream(ASN1StreamParser parser) {
    this._first = true;
    this._parser = parser;
  }
  
  public int read(byte[] b, int off, int len) throws IOException {
    if (this._currentStream == null) {
      if (!this._first)
        return -1; 
      ASN1OctetStringParser next = getNextParser();
      if (next == null)
        return -1; 
      this._first = false;
      this._currentStream = next.getOctetStream();
    } 
    int totalRead = 0;
    while (true) {
      int numRead = this._currentStream.read(b, off + totalRead, len - totalRead);
      if (numRead >= 0) {
        totalRead += numRead;
        if (totalRead == len)
          return totalRead; 
        continue;
      } 
      ASN1OctetStringParser next = getNextParser();
      if (next == null) {
        this._currentStream = null;
        return (totalRead < 1) ? -1 : totalRead;
      } 
      this._currentStream = next.getOctetStream();
    } 
  }
  
  public int read() throws IOException {
    if (this._currentStream == null) {
      if (!this._first)
        return -1; 
      ASN1OctetStringParser next = getNextParser();
      if (next == null)
        return -1; 
      this._first = false;
      this._currentStream = next.getOctetStream();
    } 
    while (true) {
      int b = this._currentStream.read();
      if (b >= 0)
        return b; 
      ASN1OctetStringParser next = getNextParser();
      if (next == null) {
        this._currentStream = null;
        return -1;
      } 
      this._currentStream = next.getOctetStream();
    } 
  }
  
  private ASN1OctetStringParser getNextParser() throws IOException {
    ASN1Encodable asn1Obj = this._parser.readObject();
    if (asn1Obj == null)
      return null; 
    if (asn1Obj instanceof ASN1OctetStringParser)
      return (ASN1OctetStringParser)asn1Obj; 
    throw new IOException("unknown object encountered: " + asn1Obj.getClass());
  }
}
