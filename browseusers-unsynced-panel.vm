## Used in browseusers.vm
#* @vtlvariable name="action" type="com.atlassian.confluence.user.actions.BrowseUnsyncedUsersAction" *#

#requireResource("confluence.web.resources:pagination-styles")
#requireResource("com.atlassian.auiplugin:aui-navigation")
<div class="user-forms-container">
    <div class="pageSection" id="user-search">
        <form method="POST" action="dosearchunsyncedusers.action" name="doUserSearch" class="aui">

            <div id="unsynced-page-explanation">
                $action.getText("unsynced.tab.page.description.when.users.present", ["$docBean.getLink('help.gdpr.delete.or.disable.users')"])
            </div>
            <div class="field-group">
                #scomponent("label='find.user'" "id=searchTerm" "name='searchTerm'" "theme='aui'" "template='text-inline.vm'"
                            "description=$i18n.getText('find.unsynced.user.description')"
                            "autofocus=true")
                #end
            </div>
            <div class="buttons-container">
                <div class="buttons">
                    <input type="submit" class="aui-button aui-button-primary" value="$action.getText('search.name')">
                    #if(!$action.isShowAll())
                        <a href="showallunsyncedusers.action?reset=true" class="aui-button aui-button-link">$action.getText('show.all.users')</a>
                    #end
                </div>
            </div>
        </form>
        #set($users = $action.pageResponse.results)

        #if($stringUtils.isNotEmpty($action.searchTerm))
            #if( $users.isEmpty())
                $action.getText("there.are.no.users")
            #else
                #set ($paginationPrefixUrlHtml="?searchTerm=$!{action.searchTerm}&")
                #set ($paginationUrlHtml="${paginationPrefixUrlHtml}resultsPerPage=$!{action.resultsPerPage}&")
                #set ($currentIndex = $action.pageResponse.pageRequest.start)
                <div id="show-options" class="pagination">
                    <h5>$action.getText("show.word"):</h5>
                    <ul class="pagination">
                        #foreach ($item in $action.resultsPerPageOptions)
                            #if ($item.key == $action.resultsPerPage)
                                <li><span class="pagination-curr">$!{item.key}</span></li>
                            #else
                                <li><a href="${paginationPrefixUrlHtml}resultsPerPage=$!{item.value}&startIndex=$!{currentIndex}">$!{item.key}</a></li>
                            #end
                        #end
                    </ul>
                </div>
                <table id="browse-user-table" class="aui user-table">
                    <thead>
                    <tr>
                        <th width="20%">$action.getText("user.name")</th>
                        <th width="40%">$action.getText("username.name")</th>
                        <th width="20%">$action.getText("email.name.withdash")</th>
                        <th width="20%">$action.getText("unsynced.user.action.title")</th>
                    </tr>
                    </thead>
                    <tbody>
                        #foreach ($user in $action.pageResponse.results.iterator())
                            ## user type here is an KnownUser
                            #set($username = $user.getUsername())
                            #set($userKey=$user.getUserKey().getOrNull())
                            #set($userActionLinkHtml = "removeunsynceduser.action?userKey=$userKey")
                        <tr id="user-row-$username">
                            <td>-</td>
                            <td>$username</td>
                            <td>-</td>
                            <td><a href="$userActionLinkHtml">$action.getText("remove")</a></td>
                        </tr>
                        #end
                    </tbody>
                </table>
                #set ($limit = $action.pageResponse.pageRequest.limit)
                #set ($nextStartIndex = $currentIndex + $limit)
            ## round up
                #set ($currentPageNum = ($currentIndex + $limit - 1)/$limit + 1)
                #set ($prevPageIndex = $currentPageNum - 2)
                #set ($previousStartIndex = $prevPageIndex * $limit)
                #if( $action.pageResponse.size() > 0 || $currentIndex > 0)
                    <ol class="aui-nav aui-nav-pagination">
                        <li class="aui-nav-previous">#if($currentIndex > 0)
                            <a href="${paginationUrlHtml}startIndex=$previousStartIndex">$action.getText('aui.prev.name')</a>
                        #else
                            <a aria-disabled="true">$action.getText('aui.prev.name')</a>
                        #end</li>
                    ## add pagination links for pages 1 through the current page
                        #if ($currentIndex > 0)
                            #foreach($i in [0..$prevPageIndex])
                                #set ($pageNum = $i + 1)
                                #set ($startIndex = $i * $limit)
                                <li><a href="${paginationUrlHtml}startIndex=$startIndex">$pageNum</a></li>
                            #end
                        #end
                        <li class="aui-nav-selected">$currentPageNum</li>
                    ## add pagination links for pages current to the end, although we don't have the full list...
                        #if($action.pageResponse.hasMore())
                            #foreach($i in [$currentPageNum..$currentPageNum])
                                #set ($pageNum = $i + 1)
                                #set ($pageIndex = $i * $limit)
                                <li><a href="${paginationUrlHtml}startIndex=$pageIndex">$pageNum</a></li>
                            #end
                        #end
                    ## add the next page
                        <li class="aui-nav-next">#if($action.pageResponse.hasMore())
                            <a href="${paginationUrlHtml}startIndex=$nextStartIndex">$action.getText('aui.next.name')</a>
                        #else
                            <a aria-disabled="true">$action.getText('aui.next.name')</a>
                        #end</li>
                    </ol>
                #end
            #end
        #end
    </div>
</div>
