#* @vtlvariable name="action" type="com.atlassian.confluence.user.actions.LoginAction" *#
#macro (errorBlock $msg)
<div class="error" tabindex="0"><p>$msg</p></div>
#end

#set($showSignup = $action.isShowSignUp())
#set($mobileAppWebView = $action.isMobileAppWebView())


<html>
	<head>
        #requireResource("confluence.web.resources:master-styles")
        #requireResource("confluence.web.resources:login")
        #requireResource("confluence.web.resources:aui-forms")
        #requireResource("com.atlassian.confluence.plugins.confluence-scriptsfinished-plugin:scriptsfinished")
	    #if( $fromNotPermitted )
		    <title>$i18n.getText("title.not.permitted")</title>
	    #else
		    <title>$action.getActionName($action.getClass().getName())</title>
		    <content tag="pageTitle"><a href="${req.contextPath}/homepage.action">$action.globalSettings.siteTitle</a></content>
		#end

        #if ($action.shouldShowMobileBanner())
            #webPanelForLocation("atl.mobile.banner" $context)
        #end
    </head>
	<body>

        <content tag="bodyClass">login</content>
		#if($showSignup)
		#requireResource("confluence.web.resources:signup")
		<script>
			AJS.$('#com-atlassian-confluence.login h1').addClass('unified-header');
		</script>
		#end

        <div id="login-container" #if($showSignup)class="unified-container"#end>
        #if ($remoteUser)
            <div class="login-section">
                <h2>$action.getText('login.name')</h2>
                #parse ('/template/includes/actionerrors.vm')
                <p>$i18n.getText('login.logged.in', $htmlUtil.htmlEncodeAndReplaceSpaces($remoteUser.name))</p>
                <p class="last">$i18n.getText('login.logged.in.description')</p>
            </div>
        #else
			<div class="login-section #if($showSignup)unified#end">
                <form name="loginform" method="POST" action="$req.contextPath/dologin.action" class="aui login-form-container">

                    #if($mobileAppWebView)
                        <div class="mobile-app-webview-logo">
                            <img src="${req.contextPath}/images/logo/confluence-logo-adg3.svg" />
                        </div>
                    #else
                        <h2>$action.getText('login.name')</h2>
                    #end


                    #if($logout)
                        <div id="logout-message" class="aui-message aui-message-success success shadowed closeable">
                            <p>$i18n.getText("successful.logout.message")</p>
                        </div>
                    #end
                    #parse ('/template/includes/actionerrors.vm')
                    <fieldset class="compact-form-fields">
                        #assistiveLegend("accessibility.form.login")
                        #stextfield("label='username.accesskey'" "name='os_username'" "theme='aui'"
                                    "focus=0"
                                    "placeholder=$i18n.getText('username.name')")
                        #spassword("label='password.accesskey'" "name='os_password'" "placeholder=$i18n.getText('password.name')")
                        #if($action.isElevatedSecurityCheckRequired())
                            #parse ("/captcha.vm")
                        #end

                        #if ($action.shouldRememberMeCheckboxBeOmitted())
                            <input type="hidden" name="os_cookie" value="true"/>
                        #else
                            #scomponent("label='remember.accesskey'" "name='os_cookie'" "value='false'" "theme='aui'" "template='onofflist.vm'")
                            #end
                        #end
                        <div class="field-group form-buttons compact-form-buttons #if($mobileAppWebView) mobile-app-form-buttons #end">
                            <input id="loginButton" class="aui-button aui-style aui-button-primary" name="login" type="submit" value="$i18n.getText('login.button')"/>
                            #if ($action.isShowForgottenPasswordHelp())
                                <a id="forgot-password" class="aui-button aui-style aui-button-link" href="${req.contextPath}/forgotuserpassword.action">$i18n.getText("forgot.password")</a>
                            #end
                        </div>
                        <input type="hidden" name="os_destination" value="$!generalUtil.refineOsDestination($!os_destination)"/>
                    </fieldset>
                    #if ($showSignup)
                        <div id="signupMessage"><p>$i18n.getText("signup.for.an.account", "<a href='$action.getSignupURL()'>", "</a>")</p></div>
                    #end
                </form>
##                #end
                </div> ## login-section

            #if ($showSignup)
            <div class="signup-section">
	            #applyDecorator("form-aui")
	                #decoratorParam("formName" "signupform")
	                #decoratorParam("submitAction" "$req.contextPath/dosignup.action")
	                #decoratorParam("editAction" "$req.contextPath/signup.action")
	                #decoratorParam("editMode" "true")
	                #decoratorParam("formStyle" "login-form-container signup")
	                #decoratorParam("autocompleteDisabled" true)

	                <h2>$action.getText("sign.up")</h2>

                    <fieldset class="right-aligned-form-fields">
	                    #assistiveLegend("accessibility.signup.legend")
	                    #stextfield("label='fullname.name.bothcaps'" "name='fullName'" "theme='aui'"
                                 "focus=0"
                                 "placeholder=$i18n.getText('fullname.name.bothcaps')")
                        #stextfield("label='email.name'" "name='email'" "theme='aui'"
                                    "type=email"
                                    "placeholder=$i18n.getText('email.name')")
	                    #stextfield("label='username.name'" "name='username'" "theme='aui'"
                                 "placeholder=$i18n.getText('username.name')")
                        #spassword("label='password.name'" "name='password'" "placeholder=$i18n.getText('password.name')")
                        #spassword("label='confirm.password.name'" "name='confirm'" "placeholder=$i18n.getText('confirm.password.name')")
                        #shidden("name='token'" "value=token" )

                        #if ($captchaManager.showCaptchaForCurrentUser())
                            #set ($captchaFormParams = { "captchaId": $captchaManager.generateCaptchaId(), "captchaErrors": $action.fieldErrors.get("captcha")})
                            $soyTemplateRendererHelper.getRenderedTemplateHtml("confluence.web.resources:shared-templates", "Confluence.Templates.Captcha.form.soy", $captchaFormParams)
                        #end

	                    <div class="field-group form-buttons compact-form-buttons">
                            <input id="signupButton" class="aui-button aui-style aui-button-primary" name="signupButton" type="submit" value="$i18n.getText('sign.up')" />
	                    </div>
	                </fieldset>
                    <div id="loginMessage"><p>$i18n.getText("signup.for.an.account.login", "<a href='$req.contextPath/login.action'>", "</a>")</p></div>
	            #end
            </div> ## signup-section
            #end
        #end
        </div>
        #if ($action.isBrowserLanguageEnabled())
            <content tag="login-language">
                <ul id="login-language">
                    #foreach ($lang in $action.getInstalledLanguages())
                        <li lang="$lang.getJsLang()">
                            <a href="$req.contextPath/login.action?language=$lang.name">$action.getLanguageManager().getDisplayName($lang)</a>
                        </li>
                    #end
                </ul>
            </content>
        #end
	</body>
</html>
