package clojure.asm;

public class Attribute {
  public final String type;
  
  private byte[] content;
  
  Attribute nextAttribute;
  
  protected Attribute(String type) { this.type = type; }
  
  public boolean isUnknown() { return true; }
  
  public boolean isCodeAttribute() { return false; }
  
  protected Label[] getLabels() { return new Label[0]; }
  
  protected Attribute read(ClassReader classReader, int offset, int length, char[] charBuffer, int codeAttributeOffset, Label[] labels) {
    Attribute attribute = new Attribute(this.type);
    attribute.content = new byte[length];
    System.arraycopy(classReader.b, offset, attribute.content, 0, length);
    return attribute;
  }
  
  protected ByteVector write(ClassWriter classWriter, byte[] code, int codeLength, int maxStack, int maxLocals) { return new ByteVector(this.content); }
  
  final int getAttributeCount() {
    int count = 0;
    Attribute attribute = this;
    while (attribute != null) {
      count++;
      attribute = attribute.nextAttribute;
    } 
    return count;
  }
  
  final int computeAttributesSize(SymbolTable symbolTable) {
    byte[] code = null;
    int codeLength = 0;
    int maxStack = -1;
    int maxLocals = -1;
    return computeAttributesSize(symbolTable, code, 0, -1, -1);
  }
  
  final int computeAttributesSize(SymbolTable symbolTable, byte[] code, int codeLength, int maxStack, int maxLocals) {
    ClassWriter classWriter = symbolTable.classWriter;
    int size = 0;
    Attribute attribute = this;
    while (attribute != null) {
      symbolTable.addConstantUtf8(attribute.type);
      size += 6 + (attribute.write(classWriter, code, codeLength, maxStack, maxLocals)).length;
      attribute = attribute.nextAttribute;
    } 
    return size;
  }
  
  final void putAttributes(SymbolTable symbolTable, ByteVector output) {
    byte[] code = null;
    int codeLength = 0;
    int maxStack = -1;
    int maxLocals = -1;
    putAttributes(symbolTable, code, 0, -1, -1, output);
  }
  
  final void putAttributes(SymbolTable symbolTable, byte[] code, int codeLength, int maxStack, int maxLocals, ByteVector output) {
    ClassWriter classWriter = symbolTable.classWriter;
    Attribute attribute = this;
    while (attribute != null) {
      ByteVector attributeContent = attribute.write(classWriter, code, codeLength, maxStack, maxLocals);
      output.putShort(symbolTable.addConstantUtf8(attribute.type)).putInt(attributeContent.length);
      output.putByteArray(attributeContent.data, 0, attributeContent.length);
      attribute = attribute.nextAttribute;
    } 
  }
}
