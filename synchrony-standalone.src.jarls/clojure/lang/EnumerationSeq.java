package clojure.lang;

import java.io.IOException;
import java.io.NotSerializableException;
import java.io.ObjectOutputStream;
import java.util.Enumeration;

public class EnumerationSeq extends ASeq {
  final Enumeration iter;
  
  final State state;
  
  public static EnumerationSeq create(Enumeration iter) {
    if (iter.hasMoreElements())
      return new EnumerationSeq(iter); 
    return null;
  }
  
  EnumerationSeq(Enumeration iter) {
    this.iter = iter;
    this.state = new State();
    this.state.val = this.state;
    this.state._rest = this.state;
  }
  
  EnumerationSeq(IPersistentMap meta, Enumeration iter, State state) {
    super(meta);
    this.iter = iter;
    this.state = state;
  }
  
  public Object first() {
    if (this.state.val == this.state)
      synchronized (this.state) {
        if (this.state.val == this.state)
          this.state.val = this.iter.nextElement(); 
      }  
    return this.state.val;
  }
  
  public ISeq next() {
    if (this.state._rest == this.state)
      synchronized (this.state) {
        if (this.state._rest == this.state) {
          first();
          this.state._rest = create(this.iter);
        } 
      }  
    return (ISeq)this.state._rest;
  }
  
  public EnumerationSeq withMeta(IPersistentMap meta) {
    if (meta() == meta)
      return this; 
    return new EnumerationSeq(meta, this.iter, this.state);
  }
  
  private void writeObject(ObjectOutputStream out) throws IOException { throw new NotSerializableException(getClass().getName()); }
}
