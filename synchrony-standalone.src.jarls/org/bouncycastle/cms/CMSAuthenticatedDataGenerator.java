package org.bouncycastle.cms;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import org.bouncycastle.asn1.ASN1EncodableVector;
import org.bouncycastle.asn1.BEROctetString;
import org.bouncycastle.asn1.BERSet;
import org.bouncycastle.asn1.DEROctetString;
import org.bouncycastle.asn1.DERSet;
import org.bouncycastle.asn1.cms.AuthenticatedData;
import org.bouncycastle.asn1.cms.CMSObjectIdentifiers;
import org.bouncycastle.asn1.cms.ContentInfo;
import org.bouncycastle.operator.DigestCalculator;
import org.bouncycastle.operator.MacCalculator;
import org.bouncycastle.util.io.TeeOutputStream;

public class CMSAuthenticatedDataGenerator extends CMSAuthenticatedGenerator {
  public CMSAuthenticatedData generate(CMSTypedData paramCMSTypedData, MacCalculator paramMacCalculator) throws CMSException { return generate(paramCMSTypedData, paramMacCalculator, null); }
  
  public CMSAuthenticatedData generate(CMSTypedData paramCMSTypedData, MacCalculator paramMacCalculator, DigestCalculator paramDigestCalculator) throws CMSException {
    AuthenticatedData authenticatedData;
    ASN1EncodableVector aSN1EncodableVector = new ASN1EncodableVector();
    for (RecipientInfoGenerator recipientInfoGenerator : this.recipientInfoGenerators)
      aSN1EncodableVector.add(recipientInfoGenerator.generate(paramMacCalculator.getKey())); 
    if (paramDigestCalculator != null) {
      DEROctetString dEROctetString;
      BEROctetString bEROctetString;
      try {
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        TeeOutputStream teeOutputStream = new TeeOutputStream(paramDigestCalculator.getOutputStream(), byteArrayOutputStream);
        paramCMSTypedData.write(teeOutputStream);
        teeOutputStream.close();
        bEROctetString = new BEROctetString(byteArrayOutputStream.toByteArray());
      } catch (IOException iOException) {
        throw new CMSException("unable to perform digest calculation: " + iOException.getMessage(), iOException);
      } 
      Map map = getBaseParameters(paramCMSTypedData.getContentType(), paramDigestCalculator.getAlgorithmIdentifier(), paramMacCalculator.getAlgorithmIdentifier(), paramDigestCalculator.getDigest());
      if (this.authGen == null)
        this.authGen = new DefaultAuthenticatedAttributeTableGenerator(); 
      DERSet dERSet = new DERSet(this.authGen.getAttributes(Collections.unmodifiableMap(map)).toASN1EncodableVector());
      try {
        OutputStream outputStream = paramMacCalculator.getOutputStream();
        outputStream.write(dERSet.getEncoded("DER"));
        outputStream.close();
        dEROctetString = new DEROctetString(paramMacCalculator.getMac());
      } catch (IOException iOException) {
        throw new CMSException("exception decoding algorithm parameters.", iOException);
      } 
      BERSet bERSet = (this.unauthGen != null) ? new BERSet(this.unauthGen.getAttributes(Collections.unmodifiableMap(map)).toASN1EncodableVector()) : null;
      ContentInfo contentInfo1 = new ContentInfo(paramCMSTypedData.getContentType(), bEROctetString);
      authenticatedData = new AuthenticatedData(this.originatorInfo, new DERSet(aSN1EncodableVector), paramMacCalculator.getAlgorithmIdentifier(), paramDigestCalculator.getAlgorithmIdentifier(), contentInfo1, dERSet, dEROctetString, bERSet);
    } else {
      DEROctetString dEROctetString;
      BEROctetString bEROctetString;
      try {
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        TeeOutputStream teeOutputStream = new TeeOutputStream(byteArrayOutputStream, paramMacCalculator.getOutputStream());
        paramCMSTypedData.write(teeOutputStream);
        teeOutputStream.close();
        bEROctetString = new BEROctetString(byteArrayOutputStream.toByteArray());
        dEROctetString = new DEROctetString(paramMacCalculator.getMac());
      } catch (IOException iOException) {
        throw new CMSException("exception decoding algorithm parameters.", iOException);
      } 
      BERSet bERSet = (this.unauthGen != null) ? new BERSet(this.unauthGen.getAttributes(new HashMap()).toASN1EncodableVector()) : null;
      ContentInfo contentInfo1 = new ContentInfo(paramCMSTypedData.getContentType(), bEROctetString);
      authenticatedData = new AuthenticatedData(this.originatorInfo, new DERSet(aSN1EncodableVector), paramMacCalculator.getAlgorithmIdentifier(), null, contentInfo1, null, dEROctetString, bERSet);
    } 
    ContentInfo contentInfo = new ContentInfo(CMSObjectIdentifiers.authenticatedData, authenticatedData);
    return new CMSAuthenticatedData(contentInfo, new Object(this, paramDigestCalculator));
  }
}
