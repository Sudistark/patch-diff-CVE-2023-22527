package org.bouncycastle.operator.jcajce;

import java.security.GeneralSecurityException;
import java.security.PrivateKey;
import java.security.Provider;
import java.security.SecureRandom;
import java.security.Signature;
import java.security.spec.AlgorithmParameterSpec;
import java.security.spec.MGF1ParameterSpec;
import java.security.spec.PSSParameterSpec;
import java.util.List;
import org.bouncycastle.asn1.ASN1EncodableVector;
import org.bouncycastle.asn1.ASN1Integer;
import org.bouncycastle.asn1.ASN1Sequence;
import org.bouncycastle.asn1.DERNull;
import org.bouncycastle.asn1.DERSequence;
import org.bouncycastle.asn1.misc.MiscObjectIdentifiers;
import org.bouncycastle.asn1.pkcs.PKCSObjectIdentifiers;
import org.bouncycastle.asn1.pkcs.RSASSAPSSparams;
import org.bouncycastle.asn1.x509.AlgorithmIdentifier;
import org.bouncycastle.jcajce.CompositePrivateKey;
import org.bouncycastle.jcajce.io.OutputStreamFactory;
import org.bouncycastle.jcajce.spec.CompositeAlgorithmSpec;
import org.bouncycastle.jcajce.util.DefaultJcaJceHelper;
import org.bouncycastle.jcajce.util.NamedJcaJceHelper;
import org.bouncycastle.jcajce.util.ProviderJcaJceHelper;
import org.bouncycastle.operator.ContentSigner;
import org.bouncycastle.operator.DefaultDigestAlgorithmIdentifierFinder;
import org.bouncycastle.operator.DefaultSignatureAlgorithmIdentifierFinder;
import org.bouncycastle.operator.OperatorCreationException;
import org.bouncycastle.util.io.TeeOutputStream;

public class JcaContentSignerBuilder {
  private OperatorHelper helper = new OperatorHelper(new DefaultJcaJceHelper());
  
  private SecureRandom random;
  
  private String signatureAlgorithm;
  
  private AlgorithmIdentifier sigAlgId;
  
  private AlgorithmParameterSpec sigAlgSpec;
  
  public JcaContentSignerBuilder(String paramString) {
    this.signatureAlgorithm = paramString;
    this.sigAlgId = (new DefaultSignatureAlgorithmIdentifierFinder()).find(paramString);
    this.sigAlgSpec = null;
  }
  
  public JcaContentSignerBuilder(String paramString, AlgorithmParameterSpec paramAlgorithmParameterSpec) {
    this.signatureAlgorithm = paramString;
    if (paramAlgorithmParameterSpec instanceof PSSParameterSpec) {
      PSSParameterSpec pSSParameterSpec = (PSSParameterSpec)paramAlgorithmParameterSpec;
      this.sigAlgSpec = pSSParameterSpec;
      this.sigAlgId = new AlgorithmIdentifier(PKCSObjectIdentifiers.id_RSASSA_PSS, createPSSParams(pSSParameterSpec));
    } else if (paramAlgorithmParameterSpec instanceof CompositeAlgorithmSpec) {
      CompositeAlgorithmSpec compositeAlgorithmSpec = (CompositeAlgorithmSpec)paramAlgorithmParameterSpec;
      this.sigAlgSpec = compositeAlgorithmSpec;
      this.sigAlgId = new AlgorithmIdentifier(MiscObjectIdentifiers.id_alg_composite, createCompParams(compositeAlgorithmSpec));
    } else {
      throw new IllegalArgumentException("unknown sigParamSpec: " + ((paramAlgorithmParameterSpec == null) ? "null" : paramAlgorithmParameterSpec.getClass().getName()));
    } 
  }
  
  public JcaContentSignerBuilder setProvider(Provider paramProvider) {
    this.helper = new OperatorHelper(new ProviderJcaJceHelper(paramProvider));
    return this;
  }
  
  public JcaContentSignerBuilder setProvider(String paramString) {
    this.helper = new OperatorHelper(new NamedJcaJceHelper(paramString));
    return this;
  }
  
  public JcaContentSignerBuilder setSecureRandom(SecureRandom paramSecureRandom) {
    this.random = paramSecureRandom;
    return this;
  }
  
  public ContentSigner build(PrivateKey paramPrivateKey) throws OperatorCreationException {
    if (paramPrivateKey instanceof CompositePrivateKey)
      return buildComposite((CompositePrivateKey)paramPrivateKey); 
    try {
      Signature signature = this.helper.createSignature(this.sigAlgId);
      AlgorithmIdentifier algorithmIdentifier = this.sigAlgId;
      if (this.random != null) {
        signature.initSign(paramPrivateKey, this.random);
      } else {
        signature.initSign(paramPrivateKey);
      } 
      return new Object(this, signature, algorithmIdentifier);
    } catch (GeneralSecurityException generalSecurityException) {
      throw new OperatorCreationException("cannot create signer: " + generalSecurityException.getMessage(), generalSecurityException);
    } 
  }
  
  private ContentSigner buildComposite(CompositePrivateKey paramCompositePrivateKey) throws OperatorCreationException {
    try {
      List list = paramCompositePrivateKey.getPrivateKeys();
      ASN1Sequence aSN1Sequence = ASN1Sequence.getInstance(this.sigAlgId.getParameters());
      Signature[] arrayOfSignature = new Signature[aSN1Sequence.size()];
      for (byte b1 = 0; b1 != aSN1Sequence.size(); b1++) {
        arrayOfSignature[b1] = this.helper.createSignature(AlgorithmIdentifier.getInstance(aSN1Sequence.getObjectAt(b1)));
        if (this.random != null) {
          arrayOfSignature[b1].initSign((PrivateKey)list.get(b1), this.random);
        } else {
          arrayOfSignature[b1].initSign((PrivateKey)list.get(b1));
        } 
      } 
      TeeOutputStream teeOutputStream1 = OutputStreamFactory.createStream(arrayOfSignature[0]);
      for (byte b2 = 1; b2 != arrayOfSignature.length; b2++)
        teeOutputStream1 = new TeeOutputStream(teeOutputStream1, OutputStreamFactory.createStream(arrayOfSignature[b2])); 
      TeeOutputStream teeOutputStream2 = teeOutputStream1;
      return new Object(this, teeOutputStream2, arrayOfSignature);
    } catch (GeneralSecurityException generalSecurityException) {
      throw new OperatorCreationException("cannot create signer: " + generalSecurityException.getMessage(), generalSecurityException);
    } 
  }
  
  private static RSASSAPSSparams createPSSParams(PSSParameterSpec paramPSSParameterSpec) {
    DefaultDigestAlgorithmIdentifierFinder defaultDigestAlgorithmIdentifierFinder = new DefaultDigestAlgorithmIdentifierFinder();
    AlgorithmIdentifier algorithmIdentifier1 = defaultDigestAlgorithmIdentifierFinder.find(paramPSSParameterSpec.getDigestAlgorithm());
    if (algorithmIdentifier1.getParameters() == null)
      algorithmIdentifier1 = new AlgorithmIdentifier(algorithmIdentifier1.getAlgorithm(), DERNull.INSTANCE); 
    AlgorithmIdentifier algorithmIdentifier2 = defaultDigestAlgorithmIdentifierFinder.find(((MGF1ParameterSpec)paramPSSParameterSpec.getMGFParameters()).getDigestAlgorithm());
    if (algorithmIdentifier2.getParameters() == null)
      algorithmIdentifier2 = new AlgorithmIdentifier(algorithmIdentifier2.getAlgorithm(), DERNull.INSTANCE); 
    return new RSASSAPSSparams(algorithmIdentifier1, new AlgorithmIdentifier(PKCSObjectIdentifiers.id_mgf1, algorithmIdentifier2), new ASN1Integer(paramPSSParameterSpec.getSaltLength()), new ASN1Integer(paramPSSParameterSpec.getTrailerField()));
  }
  
  private static ASN1Sequence createCompParams(CompositeAlgorithmSpec paramCompositeAlgorithmSpec) {
    DefaultSignatureAlgorithmIdentifierFinder defaultSignatureAlgorithmIdentifierFinder = new DefaultSignatureAlgorithmIdentifierFinder();
    ASN1EncodableVector aSN1EncodableVector = new ASN1EncodableVector();
    List list1 = paramCompositeAlgorithmSpec.getAlgorithmNames();
    List list2 = paramCompositeAlgorithmSpec.getParameterSpecs();
    for (byte b = 0; b != list1.size(); b++) {
      AlgorithmParameterSpec algorithmParameterSpec = (AlgorithmParameterSpec)list2.get(b);
      if (algorithmParameterSpec == null) {
        aSN1EncodableVector.add(defaultSignatureAlgorithmIdentifierFinder.find((String)list1.get(b)));
      } else if (algorithmParameterSpec instanceof PSSParameterSpec) {
        aSN1EncodableVector.add(createPSSParams((PSSParameterSpec)algorithmParameterSpec));
      } else {
        throw new IllegalArgumentException("unrecognized parameterSpec");
      } 
    } 
    return new DERSequence(aSN1EncodableVector);
  }
}
