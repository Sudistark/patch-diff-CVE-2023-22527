package com.hazelcast.collection.impl.list;

import com.hazelcast.collection.impl.collection.CollectionContainer;
import com.hazelcast.collection.impl.collection.CollectionService;
import com.hazelcast.collection.impl.list.operations.ListReplicationOperation;
import com.hazelcast.collection.impl.txnlist.TransactionalListProxy;
import com.hazelcast.core.DistributedObject;
import com.hazelcast.spi.NodeEngine;
import com.hazelcast.spi.Operation;
import com.hazelcast.spi.PartitionReplicationEvent;
import com.hazelcast.transaction.TransactionalObject;
import com.hazelcast.transaction.impl.Transaction;
import com.hazelcast.util.ConcurrencyUtil;
import com.hazelcast.util.ConstructorFunction;
import com.hazelcast.util.ContextMutexFactory;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;

public class ListService extends CollectionService {
  public static final String SERVICE_NAME = "hz:impl:listService";
  
  private static final Object NULL_OBJECT = new Object();
  
  private final ConcurrentMap<String, ListContainer> containerMap = new ConcurrentHashMap();
  
  private final ConcurrentMap<String, Object> quorumConfigCache = new ConcurrentHashMap();
  
  private final ContextMutexFactory quorumConfigCacheMutexFactory = new ContextMutexFactory();
  
  private final ConstructorFunction<String, Object> quorumConfigConstructor = new Object(this);
  
  public ListService(NodeEngine nodeEngine) { super(nodeEngine); }
  
  public ListContainer getOrCreateContainer(String name, boolean backup) {
    ListContainer container = (ListContainer)this.containerMap.get(name);
    if (container == null) {
      container = new ListContainer(name, this.nodeEngine);
      ListContainer current = (ListContainer)this.containerMap.putIfAbsent(name, container);
      if (current != null)
        container = current; 
    } 
    return container;
  }
  
  public ConcurrentMap<String, ? extends CollectionContainer> getContainerMap() { return this.containerMap; }
  
  public String getServiceName() { return "hz:impl:listService"; }
  
  public DistributedObject createDistributedObject(String objectId) { return new ListProxyImpl(objectId, this.nodeEngine, this); }
  
  public void destroyDistributedObject(String name) {
    super.destroyDistributedObject(name);
    this.quorumConfigCache.remove(name);
  }
  
  public TransactionalListProxy createTransactionalObject(String name, Transaction transaction) { return new TransactionalListProxy(name, transaction, this.nodeEngine, this); }
  
  public Operation prepareReplicationOperation(PartitionReplicationEvent event) {
    Map<String, CollectionContainer> migrationData = getMigrationData(event);
    return migrationData.isEmpty() ? null : new ListReplicationOperation(migrationData, event
        
        .getPartitionId(), event.getReplicaIndex());
  }
  
  public String getQuorumName(String name) {
    Object quorumName = ConcurrencyUtil.getOrPutSynchronized(this.quorumConfigCache, name, this.quorumConfigCacheMutexFactory, this.quorumConfigConstructor);
    return (quorumName == NULL_OBJECT) ? null : (String)quorumName;
  }
}
