package com.hazelcast.cache.impl.operation;

import com.hazelcast.cache.BackupAwareEntryProcessor;
import com.hazelcast.cache.impl.record.CacheRecord;
import com.hazelcast.nio.ObjectDataInput;
import com.hazelcast.nio.ObjectDataOutput;
import com.hazelcast.nio.serialization.Data;
import com.hazelcast.spi.Operation;
import java.io.IOException;
import javax.cache.processor.EntryProcessor;

public class CacheEntryProcessorOperation extends MutatingCacheOperation {
  private EntryProcessor entryProcessor;
  
  private Object[] arguments;
  
  private CacheRecord backupRecord;
  
  private EntryProcessor backupEntryProcessor;
  
  public CacheEntryProcessorOperation() {}
  
  public CacheEntryProcessorOperation(String cacheNameWithPrefix, Data key, int completionId, EntryProcessor entryProcessor, Object... arguments) {
    super(cacheNameWithPrefix, key, completionId);
    this.entryProcessor = entryProcessor;
    this.arguments = arguments;
    this.completionId = completionId;
  }
  
  public boolean shouldBackup() { return true; }
  
  public Operation getBackupOperation() {
    if (this.backupEntryProcessor != null)
      return new CacheBackupEntryProcessorOperation(this.name, this.key, this.backupEntryProcessor, this.arguments); 
    if (this.backupRecord != null)
      return new CachePutBackupOperation(this.name, this.key, this.backupRecord); 
    return new CacheRemoveBackupOperation(this.name, this.key);
  }
  
  public int getId() { return 24; }
  
  public void run() {
    this.response = this.recordStore.invoke(this.key, this.entryProcessor, this.arguments, this.completionId);
    if (this.entryProcessor instanceof BackupAwareEntryProcessor) {
      BackupAwareEntryProcessor processor = (BackupAwareEntryProcessor)this.entryProcessor;
      this.backupEntryProcessor = processor.createBackupEntryProcessor();
    } 
    if (this.backupEntryProcessor == null)
      this.backupRecord = this.recordStore.getRecord(this.key); 
  }
  
  public void afterRun() {
    if (this.recordStore.isWanReplicationEnabled()) {
      CacheRecord record = this.recordStore.getRecord(this.key);
      if (record != null) {
        publishWanUpdate(this.key, record);
      } else {
        publishWanRemove(this.key);
      } 
    } 
    super.afterRun();
  }
  
  protected void writeInternal(ObjectDataOutput out) throws IOException {
    super.writeInternal(out);
    out.writeObject(this.entryProcessor);
    out.writeBoolean((this.arguments != null));
    if (this.arguments != null) {
      out.writeInt(this.arguments.length);
      for (Object arg : this.arguments)
        out.writeObject(arg); 
    } 
  }
  
  protected void readInternal(ObjectDataInput in) throws IOException {
    super.readInternal(in);
    this.entryProcessor = (EntryProcessor)in.readObject();
    boolean hasArguments = in.readBoolean();
    if (hasArguments) {
      int size = in.readInt();
      this.arguments = new Object[size];
      for (int i = 0; i < size; i++)
        this.arguments[i] = in.readObject(); 
    } 
  }
}
