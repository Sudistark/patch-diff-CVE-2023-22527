package com.hazelcast.cache.impl.operation;

import com.hazelcast.cache.impl.CachePartitionSegment;
import com.hazelcast.cache.impl.CacheService;
import com.hazelcast.cache.impl.ICacheRecordStore;
import com.hazelcast.logging.ILogger;
import com.hazelcast.nio.Address;
import com.hazelcast.spi.AbstractLocalOperation;
import com.hazelcast.spi.NodeEngine;
import com.hazelcast.spi.PartitionAwareOperation;
import com.hazelcast.spi.impl.MutatingOperation;
import com.hazelcast.util.Clock;
import java.util.Iterator;
import java.util.logging.Level;

public class CacheClearExpiredOperation extends AbstractLocalOperation implements PartitionAwareOperation, MutatingOperation {
  private int expirationPercentage;
  
  public CacheClearExpiredOperation(int expirationPercentage) { this.expirationPercentage = expirationPercentage; }
  
  public String getServiceName() { return "hz:impl:cacheService"; }
  
  public void run() throws Exception {
    if (getNodeEngine().getLocalMember().isLiteMember())
      return; 
    if (!isOwner())
      return; 
    CacheService service = (CacheService)getService();
    CachePartitionSegment segment = service.getSegment(getPartitionId());
    Iterator<ICacheRecordStore> iterator = segment.recordStoreIterator();
    while (iterator.hasNext()) {
      ICacheRecordStore store = (ICacheRecordStore)iterator.next();
      if (store.size() > 0)
        store.evictExpiredEntries(this.expirationPercentage); 
    } 
  }
  
  private boolean isOwner() {
    NodeEngine nodeEngine = getNodeEngine();
    Address owner = nodeEngine.getPartitionService().getPartitionOwner(getPartitionId());
    return nodeEngine.getThisAddress().equals(owner);
  }
  
  public void onExecutionFailure(Throwable e) {
    try {
      super.onExecutionFailure(e);
    } finally {
      prepareForNextCleanup();
    } 
  }
  
  public void logError(Throwable e) {
    if (e instanceof com.hazelcast.spi.exception.PartitionMigratingException) {
      ILogger logger = getLogger();
      if (logger.isLoggable(Level.FINEST))
        logger.log(Level.FINEST, e.toString()); 
    } else {
      super.logError(e);
    } 
  }
  
  public void afterRun() throws Exception { prepareForNextCleanup(); }
  
  protected void prepareForNextCleanup() throws Exception {
    CacheService service = (CacheService)getService();
    CachePartitionSegment segment = service.getSegment(getPartitionId());
    segment.setRunningCleanupOperation(false);
    segment.setLastCleanupTime(Clock.currentTimeMillis());
  }
  
  public boolean returnsResponse() { return false; }
  
  protected void toString(StringBuilder sb) {
    super.toString(sb);
    sb.append(", expirationPercentage=").append(this.expirationPercentage);
  }
}
