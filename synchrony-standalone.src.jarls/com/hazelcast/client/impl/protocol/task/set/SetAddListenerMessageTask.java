package com.hazelcast.client.impl.protocol.task.set;

import com.hazelcast.client.impl.ClientEndpoint;
import com.hazelcast.client.impl.protocol.ClientMessage;
import com.hazelcast.client.impl.protocol.codec.SetAddListenerCodec;
import com.hazelcast.client.impl.protocol.task.AbstractCallableMessageTask;
import com.hazelcast.client.impl.protocol.task.ListenerMessageTask;
import com.hazelcast.collection.impl.collection.CollectionEventFilter;
import com.hazelcast.core.ItemListener;
import com.hazelcast.instance.Node;
import com.hazelcast.nio.Connection;
import com.hazelcast.nio.serialization.Data;
import com.hazelcast.security.permission.SetPermission;
import com.hazelcast.spi.EventRegistration;
import com.hazelcast.spi.EventService;
import java.security.Permission;

public class SetAddListenerMessageTask extends AbstractCallableMessageTask<SetAddListenerCodec.RequestParameters> implements ListenerMessageTask {
  public SetAddListenerMessageTask(ClientMessage clientMessage, Node node, Connection connection) { super(clientMessage, node, connection); }
  
  protected Object call() {
    EventRegistration registration;
    Data partitionKey = this.serializationService.toData(((SetAddListenerCodec.RequestParameters)this.parameters).name);
    ItemListener listener = createItemListener(this.endpoint, partitionKey);
    EventService eventService = this.clientEngine.getEventService();
    CollectionEventFilter filter = new CollectionEventFilter(((SetAddListenerCodec.RequestParameters)this.parameters).includeValue);
    if (((SetAddListenerCodec.RequestParameters)this.parameters).localOnly) {
      registration = eventService.registerLocalListener(getServiceName(), ((SetAddListenerCodec.RequestParameters)this.parameters).name, filter, listener);
    } else {
      registration = eventService.registerListener(getServiceName(), ((SetAddListenerCodec.RequestParameters)this.parameters).name, filter, listener);
    } 
    String registrationId = registration.getId();
    this.endpoint.addListenerDestroyAction(getServiceName(), ((SetAddListenerCodec.RequestParameters)this.parameters).name, registrationId);
    return registrationId;
  }
  
  private ItemListener createItemListener(ClientEndpoint endpoint, Data partitionKey) { return new Object(this, endpoint, partitionKey); }
  
  protected SetAddListenerCodec.RequestParameters decodeClientMessage(ClientMessage clientMessage) { return SetAddListenerCodec.decodeRequest(clientMessage); }
  
  protected ClientMessage encodeResponse(Object response) { return SetAddListenerCodec.encodeResponse((String)response); }
  
  public String getServiceName() { return "hz:impl:setService"; }
  
  public Object[] getParameters() { return new Object[] { null, Boolean.valueOf(((SetAddListenerCodec.RequestParameters)this.parameters).includeValue) }; }
  
  public Permission getRequiredPermission() { return new SetPermission(((SetAddListenerCodec.RequestParameters)this.parameters).name, new String[] { "listen" }); }
  
  public String getMethodName() { return "addItemListener"; }
  
  public String getDistributedObjectName() { return ((SetAddListenerCodec.RequestParameters)this.parameters).name; }
}
